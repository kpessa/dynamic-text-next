# Story 8.5: Document Editor Page (Revised)

## Status
Ready for Development

## Story
**As a** medical content creator,
**I want** a document editor with static/dynamic text sections,
**so that** I can create TPN calculation templates with embedded formulas

## Acceptance Criteria
1. Two-column layout: sections editor left, preview/output right
2. Add Static HTML and Dynamic JavaScript sections
3. Inline code editor for each section
4. Test case management per section
5. Real-time preview panel
6. Output panel showing generated content
7. No authentication required (simplified access)

## Tasks / Subtasks
- [ ] **Task 1: Create EditorPage layout** (AC: 1, 7)
  - [ ] Create page at `src/app/editor/page.tsx` (no auth group needed)
  - [ ] Implement two-column layout with sections list and preview
  - [ ] Add responsive grid for mobile (stack columns)
  - [ ] Create container with proper spacing
  - [ ] Remove auth requirements from route
  - [ ] Test layout on various screen sizes

- [ ] **Task 2: Build Section Management** (AC: 2, 3)
  - [ ] Create SectionsList at `src/features/sections/ui/SectionsList.tsx`
  - [ ] Implement "Add Static HTML" button functionality
  - [ ] Implement "Add Dynamic JS" button functionality
  - [ ] Create Section component with inline editor
  - [ ] Add drag handle for reordering sections
  - [ ] Include delete button per section
  - [ ] Store sections in Redux state

- [ ] **Task 3: Integrate Code Editor** (AC: 3)
  - [ ] Create CodeEditor at `src/widgets/code-editor/ui/CodeEditor.tsx`
  - [ ] Use Monaco Editor or CodeMirror for syntax highlighting
  - [ ] Different modes for HTML vs JavaScript
  - [ ] Auto-resize based on content
  - [ ] Add line numbers and syntax highlighting
  - [ ] Include basic auto-completion
  - [ ] Test editor performance

- [ ] **Task 4: Implement Test Case Management** (AC: 4)
  - [ ] Create TestCasePanel at `src/features/test-cases/ui/TestCasePanel.tsx`
  - [ ] Add collapsible test section per code section
  - [ ] Implement "New Test" button
  - [ ] Create "Generate Tests" with AI integration
  - [ ] Add "Manage Test Cases" modal
  - [ ] Include "AI Inspector" functionality
  - [ ] Display test count badge

- [ ] **Task 5: Build Preview Panel** (AC: 5)
  - [ ] Create PreviewPanel at `src/widgets/preview-panel/ui/PreviewPanel.tsx`
  - [ ] Render static HTML sections as-is
  - [ ] Execute dynamic JavaScript in sandboxed environment
  - [ ] Combine section outputs in order
  - [ ] Update preview on section changes (debounced)
  - [ ] Handle execution errors gracefully
  - [ ] Add loading state during execution

- [ ] **Task 6: Create Output Panel** (AC: 6)
  - [ ] Create OutputPanel at `src/widgets/output-panel/ui/OutputPanel.tsx`
  - [ ] Show final generated content
  - [ ] Display with syntax highlighting
  - [ ] Add copy-to-clipboard functionality
  - [ ] Include export options
  - [ ] Toggle between Preview and Output tabs
  - [ ] Test output generation

- [ ] **Task 7: Add Top Bar Actions** (AC: 1, 7)
  - [ ] Implement Save functionality (localStorage for now)
  - [ ] Add New document (clear all sections)
  - [ ] Create Export to clipboard
  - [ ] Add Run All Tests button
  - [ ] Include section type quick-add buttons
  - [ ] Test all toolbar actions

- [ ] **Task 8: Implement KPT Functions** (AC: 3)
  - [ ] Create floating KPT Functions button
  - [ ] Build KPT editor modal
  - [ ] Allow custom function definitions
  - [ ] Make functions available in dynamic sections
  - [ ] Store KPT functions in Redux
  - [ ] Test function availability in sections

## Dev Notes

### Previous Story Context
- Stories 8.1-8.4: Basic app structure established
- Parent Svelte app shows actual implementation patterns
- No authentication layer needed per user requirement

### Key Implementation Details from Parent App

#### Section Types
```typescript
interface Section {
  id: string;
  type: 'static' | 'dynamic';
  content: string;
  title?: string;
  order: number;
  testCases?: TestCase[];
  isExpanded: boolean;
}

interface TestCase {
  id: string;
  name: string;
  input: Record<string, any>;
  expectedOutput: string;
  status?: 'passed' | 'failed' | 'pending';
}
```

#### Editor Features from Parent
1. **Inline Editing**: Each section has its own editor
2. **Test Integration**: Test cases attached to sections, not global
3. **No Sidebar**: Ingredients accessed via modal, not sidebar
4. **Simple Navigation**: Just buttons in top bar, no complex routing

#### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- **TypeScript**: 5.7+ with strict mode
- **Frontend Framework**: Next.js 15.5.2
- **UI Library**: Material UI 7.3.2
- **Code Editor**: Monaco Editor or CodeMirror
- **State Management**: Redux Toolkit 2.8.2

#### Project Structure [Source: architecture/source-tree.md]
```
src/
├── app/
│   └── editor/
│       └── page.tsx       # Main editor page (no auth)
├── features/
│   ├── sections/         # Section management
│   ├── test-cases/       # Test case features
│   └── kpt-functions/    # KPT function editor
├── widgets/
│   ├── code-editor/      # Code editor widget
│   ├── preview-panel/    # Preview display
│   └── output-panel/     # Output display
└── shared/
    └── ui/
        └── molecules/
            └── SectionCard/  # Section UI component
```

### Component Dependencies
**From Parent App to Port:**
- Section editor with inline code editing
- Test case management UI
- Preview/Output panel switching
- KPT functions modal

**New Components Needed:**
- SectionsList - Main section container
- CodeEditor - Syntax highlighted editor
- TestCasePanel - Test management UI
- PreviewPanel - Live preview
- OutputPanel - Final output display

### No Authentication Simplification
- Remove all auth checks
- Use localStorage for persistence
- No user profiles or permissions
- Direct access to all features
- Simplified data model (no user ownership)

### Code Execution Safety
```typescript
// Sandbox execution for dynamic sections
const executeDynamicSection = (code: string, context: any) => {
  // Use Web Worker or iframe sandbox
  // Inject safe context with getValue, hasValue functions
  // Return generated HTML string
};
```

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Test Location**: Component `__tests__` folders
- **Framework**: Vitest 3.2.4

Key Test Scenarios:
1. Sections can be added/removed/reordered
2. Code executes safely in sandbox
3. Preview updates with changes
4. Test cases run correctly
5. Export generates valid output
6. No auth required for access
7. KPT functions available in context

### Accessibility Requirements
- Keyboard navigation between sections
- Screen reader support for buttons
- Focus management in modals
- Proper ARIA labels
- High contrast support

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-06 | 2.0 | Revised based on parent app analysis | Scrum Master |

## Dev Agent Record
_To be populated by development agent_

### Agent Model Used
_To be populated_

### Debug Log References
_To be populated_

### Completion Notes List
_To be populated_

### File List
_To be populated_

## QA Results
_To be populated by QA agent_