# Story 4.3: TPN Configuration Import Enhancement

## Status
Ready for Development

## Story
**As a** healthcare provider,
**I want** to import full TPN configuration files with all ingredient details,
**so that** I can use existing configuration data in the dynamic text editor with proper ingredient grouping and reference ranges

## Acceptance Criteria
1. Support complete TPN configuration schema matching original Svelte format
2. Import modal accessible from editor home page toolbar
3. Validate configuration files with detailed error messages
4. Population type selection (NEO, CHILD, ADOLESCENT, ADULT)
5. Preview configuration data before confirming import
6. Imported ingredients appear in sidebar grouped by type
7. Configuration context available to dynamic text execution
8. Support for FLEX configuration overrides
9. Import history maintained in localStorage
10. Export current configuration in compatible format

## Tasks / Subtasks
- [x] **Task 1: Enhance Configuration Schema** (AC: 1, 8)
  - [x] Update TypeScript interfaces in `/src/features/data-import/types/schemas.ts`
  - [x] Add INGREDIENT properties: OSMO_RATIO, PRECISION, SPECIAL, NOTE, ALTUOM
  - [x] Add LABS, CONCENTRATION, EXCLUDES to ingredient schema
  - [x] Add FLEX configuration array with ALT_VALUE support
  - [x] Create type guards for runtime validation

- [x] **Task 2: Enhance Validation Service** (AC: 3, 4)
  - [x] Update `/src/features/data-import/lib/validator.ts`
  - [x] Add validation for new schema fields
  - [x] Implement population type validation
  - [x] Add FLEX configuration validation
  - [x] Improve error messages with field-specific details

- [x] **Task 3: Create Import Modal Component** (AC: 2, 4, 5)
  - [x] Create `/src/widgets/import-modal/ui/ImportModal.tsx`
  - [x] Add file upload interface
  - [x] Include population type selector dropdown
  - [x] Display preview of configuration structure
  - [x] Show validation results before confirmation

- [x] **Task 4: Integrate with Editor Home Page** (AC: 2, 6)
  - [x] Add import button to editor toolbar
  - [x] Connect modal to Redux store
  - [x] Update editor state with imported configuration
  - [x] Trigger sidebar refresh on successful import

- [x] **Task 5: Wire Ingredients to Sidebar** (AC: 6)
  - [x] Update `/src/widgets/ingredient-sidebar/ui/IngredientSidebar.tsx`
  - [x] Replace mock data with Redux selector
  - [x] Add Redux slice for ingredients if not exists
  - [x] Map imported ingredients to sidebar format
  - [x] Maintain ingredient grouping by type

- [ ] **Task 6: Add Configuration Context** (AC: 7)
  - [ ] Create `/src/shared/contexts/ConfigurationContext.tsx`
  - [ ] Include population type and health system metadata
  - [ ] Make context available to SecureCodeExecutor
  - [ ] Pass configuration values to dynamic text execution
  - [ ] Include FLEX overrides in context

- [ ] **Task 7: Implement Import/Export Round-trip** (AC: 9, 10)
  - [ ] Enhance export functionality for full schema
  - [ ] Ensure exported format matches import format
  - [ ] Add timestamp and metadata to exports
  - [ ] Test round-trip import/export compatibility

- [ ] **Task 8: Add Comprehensive Tests** (AC: All)
  - [ ] Test schema validation with valid/invalid files
  - [ ] Test population type handling
  - [ ] Test FLEX configuration overrides
  - [ ] Test Redux state updates
  - [ ] Test sidebar ingredient display
  - [ ] Test configuration context integration

## Dev Notes

### Previous Story Context
This story builds upon Story 3.4 (JSON Data Import) which implemented basic import/export. This enhancement brings full compatibility with the original Svelte application's TPN configuration format.

### Original Svelte Schema Structure
```typescript
// From Svelte app: src/lib/services/tpnConfigService.ts
export interface Ingredient {
  KEYNAME: string;
  DISPLAY: string;
  MNEMONIC: string;
  UOM_DISP: string;
  TYPE: IngredientType;
  OSMO_RATIO: number;
  EDITMODE: EditMode;
  PRECISION: number;
  SPECIAL: string;
  NOTE: NoteObject[];
  ALTUOM: AltUOM[];
  REFERENCE_RANGE: ReferenceRange[];
  LABS: Lab[];
  CONCENTRATION: Concentration;
  EXCLUDES: Exclude[];
}

export interface FlexConfig {
  NAME: string;
  VALUE: string;
  CONFIG_COMMENT?: string;
  ALT_VALUE?: AltValue[];
}

export interface TPNConfiguration {
  INGREDIENT: Ingredient[];
  FLEX: FlexConfig[];
}
```

### Population Type Mapping
```typescript
export type PopulationType = 'NEO' | 'CHILD' | 'ADOLESCENT' | 'ADULT';

// File naming convention examples:
// neo-cert-east-uhs.json
// child-build-main-choc.json
// adult-cert-west-memorial.json
```

### Reference Range Thresholds
```typescript
export type ThresholdType = 
  | 'Feasible Low' 
  | 'Critical Low' 
  | 'Normal Low' 
  | 'Normal High' 
  | 'Critical High' 
  | 'Feasible High';
```

### Import Modal UI Flow
1. User clicks "Import Configuration" button in toolbar
2. Modal opens with file upload and population type selector
3. User selects file and population type
4. System validates and shows preview
5. User confirms or cancels import
6. On confirm, ingredients populate sidebar
7. Configuration context updates for dynamic text

### Redux State Structure
```typescript
interface ConfigurationState {
  current: TPNConfiguration | null;
  populationType: PopulationType | null;
  healthSystem: string | null;
  ingredients: Ingredient[];
  flexOverrides: FlexConfig[];
  importHistory: ImportHistoryItem[];
  isLoading: boolean;
  error: string | null;
}
```

### Integration Points
1. **Ingredient Sidebar**: Uses `ingredients` from configuration state
2. **Dynamic Text Editor**: Accesses configuration via context
3. **Preview Panel**: Uses configuration for value substitution
4. **Export Feature**: Generates full configuration JSON

### Validation Requirements
- KEYNAME must be unique within configuration
- OSMO_RATIO must be numeric
- PRECISION must be integer 0-10
- TYPE must be valid IngredientType
- REFERENCE_RANGE must have valid threshold types
- FLEX NAME must match existing configuration keys

### Example Configuration File
```json
{
  "INGREDIENT": [
    {
      "KEYNAME": "dextrose",
      "DISPLAY": "Dextrose",
      "MNEMONIC": "DEX",
      "UOM_DISP": "g/kg/day",
      "TYPE": "Macronutrient",
      "OSMO_RATIO": 5.5,
      "EDITMODE": "Custom",
      "PRECISION": 1,
      "SPECIAL": "",
      "NOTE": [{"TEXT": "Primary energy source"}],
      "ALTUOM": [{"NAME": "mg/kg/min", "UOM_DISP": "mg/kg/min"}],
      "REFERENCE_RANGE": [
        {"THRESHOLD": "Normal Low", "VALUE": 4.0},
        {"THRESHOLD": "Normal High", "VALUE": 18.0}
      ],
      "LABS": [],
      "CONCENTRATION": {"STRENGTH": 50, "STRENGTH_UOM": "g", "VOLUME": 100, "VOLUME_UOM": "mL"},
      "EXCLUDES": []
    }
  ],
  "FLEX": [
    {
      "NAME": "MAX_DEXTROSE_RATE",
      "VALUE": "12",
      "CONFIG_COMMENT": "Maximum dextrose infusion rate",
      "ALT_VALUE": [
        {"CHECKTYPE": "population", "CHECKMATCH": "NEO", "OVERRIDE_VALUE": "10"}
      ]
    }
  ]
}
```

## Testing

### Testing Standards
- Unit tests for all schema validators
- Integration tests for import flow
- Component tests for Import Modal
- E2E tests for complete import-to-editor workflow
- Test with real configuration files from Svelte app

### Test Requirements for This Story
1. Validate all original Svelte configuration files import successfully
2. Test population type detection and selection
3. Test FLEX override application
4. Test ingredient sidebar population
5. Test configuration context in dynamic text
6. Test export generates valid importable file
7. Test error handling for malformed files
8. Test import history persistence

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-06 | 1.0 | Created story for TPN configuration import | Dev Agent |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Task 1-3 implementation: 2025-09-06 18:27-18:41
- Task 4-5 implementation: 2025-09-06 18:48-19:05

### Completion Notes List
- Enhanced schema to support full TPN configuration format from Svelte app
- Created comprehensive validation with detailed error messages
- Built import modal with file upload, preview, and population type selection
- Added Redux configuration slice for state management
- Integrated import button into header widget
- Connected ingredient sidebar to Redux configuration state
- All tests passing for schema types, validation, and UI component

### File List
- /src/features/data-import/types/schemas.ts (modified)
- /src/features/data-import/types/schemas.test.ts (created)
- /src/features/data-import/lib/validator.ts (modified)
- /src/features/data-import/lib/validator.test.ts (modified)
- /src/widgets/import-modal/ui/ImportModal.tsx (created)
- /src/widgets/import-modal/ui/ImportModal.test.tsx (created)
- /src/widgets/import-modal/index.ts (created)
- /src/features/data-import/model/configurationSlice.ts (created)
- /src/app/store.ts (modified)
- /src/features/data-import/index.ts (modified)
- /src/widgets/header/ui/HeaderWidget.tsx (modified)
- /src/widgets/ingredient-sidebar/ui/IngredientSidebar.tsx (modified)

## QA Results