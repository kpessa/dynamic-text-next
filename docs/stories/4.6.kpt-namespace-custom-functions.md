# Story 4.6: KPT Namespace & Custom Functions

## Status
Ready for Development

## Story
**As a** content creator,
**I want** a comprehensive KPT namespace with formatting and utility functions,
**so that** I can create rich, formatted dynamic text with conditional logic and TPN-specific formatting.

## Acceptance Criteria
1. KPT namespace with all formatting functions
2. Text formatting functions (colors, styles)
3. Number and currency formatting
4. TPN-specific formatters (weight, volume, dose)
5. Conditional display functions
6. Range checking utilities
7. HTML building functions
8. Custom function creation and management

## Tasks / Subtasks
- [ ] **Task 1: Create KPT Namespace Core** (AC: 1)
  - [ ] Define KPT namespace interface at `src/features/kpt-functions/types/index.ts`
  - [ ] Create namespace factory at `src/features/kpt-functions/lib/kptNamespace.ts`
  - [ ] Implement namespace injection into evaluation context
  - [ ] Add TypeScript type definitions for all functions
  - [ ] Create function registry system
  - [ ] Build namespace documentation generator

- [ ] **Task 2: Implement Text Formatting Functions** (AC: 2)
  - [ ] Create text formatters at `src/features/kpt-functions/lib/textFormatters.ts`
  - [ ] Implement redText, greenText, blueText functions
  - [ ] Add boldText, italicText, underlineText
  - [ ] Create highlightText with custom colors
  - [ ] Build text transformation utilities
  - [ ] Add HTML escaping for safety

- [ ] **Task 3: Build Number Formatting Functions** (AC: 3)
  - [ ] Create number formatters at `src/features/kpt-functions/lib/numberFormatters.ts`
  - [ ] Implement roundTo with precision control
  - [ ] Add formatNumber with locale support
  - [ ] Create formatPercent with customization
  - [ ] Build formatCurrency with symbol options
  - [ ] Add scientific notation formatter

- [ ] **Task 4: Create TPN-Specific Formatters** (AC: 4)
  - [ ] Build TPN formatters at `src/features/kpt-functions/lib/tpnFormatters.ts`
  - [ ] Implement formatWeight with unit conversion
  - [ ] Create formatVolume with mL/L support
  - [ ] Add formatDose with precision control
  - [ ] Build formatConcentration calculator
  - [ ] Create formatInfusionRate function
  - [ ] Add formatOsmolarity calculator

- [ ] **Task 5: Implement Conditional Display Functions** (AC: 5)
  - [ ] Create conditionals at `src/features/kpt-functions/lib/conditionalDisplay.ts`
  - [ ] Implement showIf/hideIf functions
  - [ ] Add whenAbove/whenBelow threshold checks
  - [ ] Create whenInRange function
  - [ ] Build switch/case equivalent
  - [ ] Add conditional styling functions

- [ ] **Task 6: Build Range Checking Functions** (AC: 6)
  - [ ] Create range checkers at `src/features/kpt-functions/lib/rangeCheckers.ts`
  - [ ] Implement checkRange with normal/critical thresholds
  - [ ] Add isNormal/isCritical boolean functions
  - [ ] Create getRangeStatus function
  - [ ] Build population-specific range checking
  - [ ] Add visual range indicators

- [ ] **Task 7: Create HTML Building Functions** (AC: 7)
  - [ ] Build HTML generators at `src/features/kpt-functions/lib/htmlBuilders.ts`
  - [ ] Implement createTable with headers
  - [ ] Add createList (ordered/unordered)
  - [ ] Create createAlert with types
  - [ ] Build createCard component
  - [ ] Add createProgress indicator
  - [ ] Implement safe HTML sanitization

- [ ] **Task 8: Implement Custom Function Management** (AC: 8)
  - [ ] Create custom function service at `src/features/kpt-functions/lib/customFunctionService.ts`
  - [ ] Build function editor UI component
  - [ ] Implement function validation
  - [ ] Add function persistence to Firestore
  - [ ] Create function sharing mechanism
  - [ ] Build function versioning

- [ ] **Task 9: Build Redux Integration** (AC: All)
  - [ ] Create KPT slice at `src/features/kpt-functions/model/kptSlice.ts`
  - [ ] Manage custom functions in state
  - [ ] Track function usage statistics
  - [ ] Handle function errors
  - [ ] Create function selectors
  - [ ] Add function caching

- [ ] **Task 10: Write Tests** (AC: All)
  - [ ] Unit tests for all KPT functions
  - [ ] Test formatting accuracy
  - [ ] Test conditional logic
  - [ ] Test range checking edge cases
  - [ ] Test HTML generation safety
  - [ ] Integration tests with dynamic text editor
  - [ ] Performance tests for complex expressions

## Dev Notes

### Previous Story Context
From Story 4.2 (Dynamic Text Editor):
- KPT namespace needs to be injected into evaluation context
- Functions called within dynamic sections

From Story 4.3 (Formula Calculations):
- KPT functions can be used in formulas
- Need to maintain consistent number formatting

From Story 4.5 (Ingredient Management):
- Range checking functions use ingredient reference ranges
- Population-specific formatting needed

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- TypeScript 5.7+ with strict mode
- DOMPurify for HTML sanitization
- Intl API for number/currency formatting

#### Project Structure [Source: architecture/source-tree.md]
- KPT functions feature: `/src/features/kpt-functions/`
- Integration with dynamic text editor
- Follow FSD layer dependencies

### Parent Project KPT Namespace Structure
From `../dynamic-text/src/lib/kptNamespace.ts`:
```typescript
export type KPTNamespace = {
  // Text formatting functions
  redText: (text: string | number) => string;
  greenText: (text: string | number) => string;
  blueText: (text: string | number) => string;
  boldText: (text: string | number) => string;
  italicText: (text: string | number) => string;
  highlightText: (text: string | number, color?: string) => string;
  
  // Number formatting functions
  roundTo: (num: number, decimals?: number) => number;
  formatNumber: (num: number, decimals?: number) => string;
  formatPercent: (num: number, decimals?: number) => string;
  formatCurrency: (num: number, currency?: string) => string;
  
  // TPN-specific formatting
  formatWeight: (weight: number, unit?: string) => string;
  formatVolume: (volume: number, unit?: string) => string;
  formatDose: (dose: number, unit?: string) => string;
  formatConcentration: (concentration: number) => string;
  
  // Conditional display functions
  showIf: (condition: boolean, content: string) => string;
  hideIf: (condition: boolean, content: string) => string;
  whenAbove: (value: number, threshold: number, content: string) => string;
  whenBelow: (value: number, threshold: number, content: string) => string;
  whenInRange: (value: number, min: number, max: number, content: string) => string;
  
  // Range checking functions
  checkRange: (value: number, normal?: [number, number], critical?: [number, number]) => string;
  isNormal: (value: number, min: number, max: number) => boolean;
  isCritical: (value: number, criticalMin: number, criticalMax: number) => boolean;
  
  // HTML building functions
  createTable: (data: Array<Array<string | number>>, headers?: string[]) => string;
  createList: (items: Array<string | number>, ordered?: boolean) => string;
  createAlert: (message: string, type?: 'info' | 'warning' | 'error' | 'success') => string;
  
  // Utility functions
  capitalize: (text: string) => string;
  pluralize: (count: number, singular: string, plural?: string) => string;
  abbreviate: (text: string, maxLength: number) => string;
};
```

### Function Implementation Examples

**Text Formatting:**
```typescript
const redText = (text: string | number): string => {
  return `<span style="color: red;">${text}</span>`;
};

const highlightText = (text: string | number, color = 'yellow'): string => {
  return `<span style="background-color: ${color}; padding: 2px 4px;">${text}</span>`;
};
```

**Number Formatting:**
```typescript
const formatNumber = (num: number, decimals = 2): string => {
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(num);
};

const formatCurrency = (num: number, currency = 'USD'): string => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency
  }).format(num);
};
```

**TPN Formatters:**
```typescript
const formatWeight = (weight: number, unit = 'kg'): string => {
  if (unit === 'kg' && weight < 1) {
    return `${(weight * 1000).toFixed(0)} g`;
  }
  return `${weight.toFixed(2)} ${unit}`;
};

const formatDose = (dose: number, unit = 'mg'): string => {
  if (dose < 1 && unit === 'mg') {
    return `${(dose * 1000).toFixed(0)} mcg`;
  }
  if (dose >= 1000 && unit === 'mg') {
    return `${(dose / 1000).toFixed(2)} g`;
  }
  return `${dose.toFixed(2)} ${unit}`;
};
```

**Conditional Display:**
```typescript
const whenInRange = (value: number, min: number, max: number, content: string): string => {
  return value >= min && value <= max ? content : '';
};

const checkRange = (value: number, normal?: [number, number], critical?: [number, number]): string => {
  if (critical && (value < critical[0] || value > critical[1])) {
    return 'critical';
  }
  if (normal && (value < normal[0] || value > normal[1])) {
    return 'abnormal';
  }
  return 'normal';
};
```

**HTML Builders:**
```typescript
const createTable = (data: Array<Array<string | number>>, headers?: string[]): string => {
  let html = '<table class="kpt-table">';
  
  if (headers) {
    html += '<thead><tr>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead>';
  }
  
  html += '<tbody>';
  data.forEach(row => {
    html += '<tr>';
    row.forEach(cell => html += `<td>${cell}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table>';
  
  return DOMPurify.sanitize(html);
};

const createAlert = (message: string, type = 'info'): string => {
  const colors = {
    info: '#2196F3',
    warning: '#FF9800',
    error: '#F44336',
    success: '#4CAF50'
  };
  
  return DOMPurify.sanitize(`
    <div style="padding: 12px; background: ${colors[type]}; color: white; border-radius: 4px;">
      ${message}
    </div>
  `);
};
```

### Custom Function Pattern
```typescript
interface CustomFunction {
  id: string;
  name: string;
  description: string;
  parameters: Parameter[];
  body: string;
  returnType: 'string' | 'number' | 'boolean';
  category: string;
  isPublic: boolean;
  version: number;
}

class CustomFunctionService {
  async createFunction(func: CustomFunction): Promise<void> {
    // Validate function syntax
    const validation = this.validateFunction(func);
    if (!validation.isValid) {
      throw new Error(validation.error);
    }
    
    // Compile function
    const compiled = new Function(...func.parameters.map(p => p.name), func.body);
    
    // Store in Firestore
    await setDoc(doc(db, 'customFunctions', func.id), func);
    
    // Add to namespace
    this.registerFunction(func.name, compiled);
  }
}
```

### Integration with Dynamic Text Editor
```typescript
// In dynamic section evaluation
const evaluateSection = (code: string, context: any) => {
  const kpt = createKPTNamespace();
  const customFunctions = getCustomFunctions();
  
  const fullContext = {
    ...context,
    kpt,
    ...customFunctions
  };
  
  // Safe evaluation with KPT functions available
  return evaluateCode(code, fullContext);
};
```

### Performance Considerations
- Cache compiled custom functions
- Lazy load HTML builder functions
- Memoize expensive formatters
- Use Web Workers for complex calculations

### Security Considerations
- Sanitize all HTML output with DOMPurify
- Validate custom function code
- Limit function execution time
- Sandbox custom function execution
- Prevent access to global scope

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- Unit tests for every KPT function
- Test edge cases and boundary conditions
- Test HTML sanitization
- Performance tests for complex operations

#### Key Test Scenarios
- Format numbers with various locales
- Test conditional logic with edge cases
- Verify HTML sanitization works
- Test range checking accuracy
- Custom function creation and execution
- Integration with dynamic text evaluation
- Performance with 100+ function calls

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_