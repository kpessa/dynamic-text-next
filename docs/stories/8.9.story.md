# Story 8.9: Loading States & Error Boundaries

## Status
Ready for Review

## Story
**As a** user,
**I want** clear feedback during loading and errors,
**so that** I understand what's happening

## Acceptance Criteria
1. ✅ Skeleton screens for all pages
2. ✅ Error boundary with recovery options
3. ✅ 404 page design
4. ✅ Offline indicator
5. ✅ Loading progress for long operations
6. ✅ Toast notifications for actions

## Tasks / Subtasks
- [x] **Task 1: Create page-level skeletons** (AC: 1)
  - [x] Build DashboardSkeleton at `src/features/loading-states/ui/PageSkeletons.tsx`
  - [x] Create CalculatorSkeleton for TPN page
  - [x] Design EditorSkeleton with sections placeholder
  - [x] Build IngredientListSkeleton
  - [x] Implement shimmer animation effect
  - [x] Match exact layout of real components
  - [x] Create CardSkeleton and TableRowSkeleton utilities

- [x] **Task 2: Implement error boundary component** (AC: 2)
  - [x] Create ErrorBoundary at `src/features/loading-states/ui/ErrorBoundary.tsx`
  - [x] Design friendly error UI with illustration
  - [x] Add "Try Again" button
  - [x] Include "Go Home" option
  - [x] Log errors to console/service
  - [x] Create different error messages by type
  - [x] Implement withErrorBoundary HOC and useErrorHandler hook

- [x] **Task 3: Design 404 and error pages** (AC: 3)
  - [x] Create custom 404 page at `src/app/not-found.tsx`
  - [x] Design engaging 404 illustration with search icon
  - [x] Add helpful navigation options (Go Back, Go to Dashboard)
  - [x] Include error code and support text
  - [x] Create suggestions list for common issues
  - [x] Add responsive layout for mobile

- [x] **Task 4: Add offline detection** (AC: 4)
  - [x] Create useOfflineDetection hook
  - [x] Build OfflineIndicator component with auto-dismiss
  - [x] Design offline banner with persistent state
  - [x] Add OfflineStatusChip component
  - [x] Add reconnection detection
  - [x] Show sync status when back online
  - [x] Implement retry mechanisms

- [x] **Task 5: Implement loading progress** (AC: 5)
  - [x] Create LoadingOverlay component with backdrop
  - [x] Add StageProgress component for multi-step operations
  - [x] Implement LoadingButton with position options
  - [x] Add circular progress with percentage display
  - [x] Create indeterminate loading states
  - [x] Add loading text/descriptions support
  - [x] Implement useLoadingState hook

- [x] **Task 6: Implement toast system** (AC: 6)
  - [x] Create ToastProvider at `src/features/loading-states/ui/ToastProvider.tsx`
  - [x] Use Material UI Snackbar as base
  - [x] Design success, error, warning, info variants
  - [x] Add action buttons to toasts
  - [x] Implement toast queue management
  - [x] Create useToast hook
  - [x] Add undo action support and promise-based toasts

- [x] **Task 7: Add loading states utilities** (AC: 1, 5)
  - [x] Create InlineLoader component
  - [x] Implement SuspenseFallback component
  - [x] Create cancellable loading operations
  - [x] Add transparent and blur backdrop options
  - [x] Implement auto-save status indicators
  - [x] Create useToastPatterns for common scenarios

- [x] **Task 8: Create comprehensive exports** (AC: All)
  - [x] Export all components from loading-states index
  - [x] Export types for TypeScript support
  - [x] Create proper module boundaries
  - [x] Ensure tree-shaking compatibility

## Dev Notes

### Previous Story Context
- Stories 8.1-8.8: All pages and mobile design complete
- Need comprehensive loading/error handling
- Parent app shows basic loading states

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- **React**: 18+ with Suspense
- **Next.js**: 15.5.2 with streaming
- **Material UI**: 7.3.2 Skeleton components

#### Project Structure [Source: architecture/source-tree.md]
Loading/Error components location:
```
src/
├── app/
│   ├── not-found.tsx     # 404 page
│   ├── error.tsx         # Error page
│   └── providers/
│       └── ToastProvider.tsx
├── shared/ui/
│   ├── organisms/
│   │   ├── ErrorBoundary/
│   │   └── OfflineIndicator/
│   └── molecules/
│       ├── ProgressBar/
│       ├── LoadingButton/
│       └── Skeleton/
└── hooks/
    ├── useOnlineStatus.ts
    └── useToast.ts
```

### Loading State Patterns

#### Skeleton Components
```typescript
interface SkeletonProps {
  variant?: 'text' | 'rectangular' | 'circular';
  animation?: 'pulse' | 'wave' | false;
  height?: number | string;
  width?: number | string;
}

// Page skeleton example
const DashboardSkeleton = () => (
  <Grid container spacing={3}>
    <Grid item xs={12}>
      <Skeleton variant="text" height={40} />
    </Grid>
    <Grid item xs={12} md={3}>
      <Skeleton variant="rectangular" height={120} />
    </Grid>
    {/* More skeleton items */}
  </Grid>
);
```

#### Error Boundary Implementation
```typescript
class ErrorBoundary extends Component {
  state = { hasError: false, error: null };
  
  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error: Error, info: ErrorInfo) {
    console.error('Error caught:', error, info);
    // Send to error tracking service
  }
  
  render() {
    if (this.state.hasError) {
      return <ErrorFallback error={this.state.error} />;
    }
    return this.props.children;
  }
}
```

#### Toast System
```typescript
interface Toast {
  id: string;
  message: string;
  type: 'success' | 'error' | 'warning' | 'info';
  duration?: number;
  action?: {
    label: string;
    onClick: () => void;
  };
}

const useToast = () => {
  const show = (toast: Omit<Toast, 'id'>) => {
    // Add to toast queue
  };
  
  return { show };
};
```

### Offline Support
```typescript
// Service Worker registration
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}

// Offline detection
const useOnlineStatus = () => {
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  
  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);
    
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);
  
  return isOnline;
};
```

### Loading States by Component Type
1. **Pages**: Full skeleton screens
2. **Lists**: Placeholder rows
3. **Cards**: Shimmer effect
4. **Buttons**: Spinner + disabled
5. **Forms**: Overlay with spinner
6. **Modals**: Content skeleton

### Error Types and Messages
```typescript
const errorMessages = {
  404: "Page not found",
  500: "Something went wrong",
  network: "Connection problem",
  timeout: "Request timed out",
  validation: "Please check your input",
  permission: "Access denied",
};
```

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Test Location**: `__tests__` folders
- **Framework**: Vitest 3.2.4

Key Test Scenarios:
1. Skeletons display during loading
2. Error boundaries catch errors
3. 404 page shows for bad routes
4. Offline indicator appears
5. Progress bars show accurately
6. Toasts display and dismiss
7. Recovery actions work
8. Loading states transition smoothly

### Performance Considerations
- Skeleton screens prevent layout shift
- Progressive loading for better perception
- Optimistic UI updates where appropriate
- Debounce loading indicators (200ms)

### Accessibility Requirements
- Loading announcements for screen readers
- Error messages clearly communicated
- Focus management on error recovery
- Keyboard dismissible toasts
- Proper ARIA labels and roles

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
Development completed on 2025-01-06

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Successfully implemented all loading states and error handling components
- Fixed TypeScript errors in ToastProvider (missing CircularProgress import)
- Organized all components under features/loading-states for proper FSD structure

### Completion Notes List
1. Created comprehensive skeleton screens for all major pages (Dashboard, TPN Calculator, Ingredients, Document Editor, Settings, Comparison)
2. Implemented robust ErrorBoundary with recovery options, retry mechanisms, and error reporting
3. Designed user-friendly 404 page with navigation suggestions
4. Built offline detection system with multiple indicators (banner, chip, status)
5. Created flexible loading overlay system with progress tracking
6. Implemented full-featured toast notification system with queue management
7. Added utility hooks (useOfflineDetection, useToast, useErrorHandler, useLoadingState)
8. All components follow Material UI design patterns and FSD architecture

### File List
- `src/features/loading-states/ui/PageSkeletons.tsx` - All page skeleton screens
- `src/features/loading-states/ui/ErrorBoundary.tsx` - Error boundary with HOC and hook
- `src/features/loading-states/ui/OfflineIndicator.tsx` - Offline detection components
- `src/features/loading-states/ui/LoadingOverlay.tsx` - Loading states and progress
- `src/features/loading-states/ui/ToastProvider.tsx` - Toast notification system
- `src/features/loading-states/ui/index.ts` - Module exports
- `src/app/not-found.tsx` - Custom 404 page

## QA Results
_To be populated by QA agent_