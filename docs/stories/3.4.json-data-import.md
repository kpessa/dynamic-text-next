# Story 3.4: JSON Data Import

## Status
Ready for Development

## Story
**As a** user,
**I want** to import JSON data via file upload or copy/paste,
**so that** I can load configuration data into the application.

## Acceptance Criteria
1. JSON file upload via standard file input
2. Copy/paste JSON into text area
3. JSON validation with clear error messages
4. Parse and load JSON into Redux state
5. Support for expected JSON schemas
6. Import history in local storage (optional)
7. Clear UI feedback for success/failure

## Tasks / Subtasks
- [ ] **Task 1: Create JSON Import Component** (AC: 1, 2)
  - [ ] Create JsonImport component at `src/features/data-import/ui/JsonImport.tsx`
  - [ ] Add file input element for .json files
  - [ ] Add textarea for paste functionality
  - [ ] Create toggle between file/paste modes
  - [ ] Style with Material UI components

- [ ] **Task 2: Implement JSON Validation** (AC: 3, 5)
  - [ ] Create validation service at `src/features/data-import/lib/validator.ts`
  - [ ] Validate JSON syntax
  - [ ] Validate against expected schemas (TPN, ingredients, references)
  - [ ] Create TypeScript types for valid data structures
  - [ ] Return detailed error messages with line numbers for invalid data

- [ ] **Task 3: Create Redux Integration** (AC: 4, 6)
  - [ ] Create import slice at `src/features/data-import/model/importSlice.ts`
  - [ ] Store imported data in appropriate entity slices
  - [ ] Track import history in local storage
  - [ ] Handle import errors in state
  - [ ] Create actions for different data types

- [ ] **Task 4: Build Import UI Feedback** (AC: 7)
  - [ ] Create success notifications using Material UI Snackbar
  - [ ] Create error display with syntax highlighting
  - [ ] Add loading state during JSON processing
  - [ ] Show data preview before confirming import
  - [ ] Add confirmation dialog for data replacement

- [ ] **Task 5: Create Data Export Feature** (AC: Additional)
  - [ ] Add export functionality to download current state as JSON
  - [ ] Create export button in UI
  - [ ] Format JSON with proper indentation
  - [ ] Include timestamp in exported filename

- [ ] **Task 6: Write Tests** (AC: All)
  - [ ] Test file reading functionality
  - [ ] Test JSON parsing and validation
  - [ ] Test error scenarios (invalid JSON, wrong schema)
  - [ ] Test Redux state updates
  - [ ] Test import/export round-trip

## Dev Notes

### Previous Story Context
This story replaces the complex Firebase Storage integration with a simple client-side JSON import/export feature, similar to the original Svelte implementation.

### File Reading Implementation
```typescript
// src/features/data-import/ui/JsonImport.tsx
import { ChangeEvent, useState } from 'react';
import { useDispatch } from 'react-redux';

const handleFileUpload = (event: ChangeEvent<HTMLInputElement>) => {
  const file = event.target.files?.[0];
  if (!file) return;
  
  if (file.type !== 'application/json') {
    setError('Please select a JSON file');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const text = e.target?.result as string;
      const json = JSON.parse(text);
      validateAndImport(json);
    } catch (error) {
      setError('Invalid JSON file: ' + error.message);
    }
  };
  reader.onerror = () => setError('Failed to read file');
  reader.readAsText(file);
};
```

### Copy/Paste Implementation
```typescript
const handlePaste = (text: string) => {
  if (!text.trim()) {
    setError('Please paste valid JSON');
    return;
  }
  
  try {
    const json = JSON.parse(text);
    validateAndImport(json);
  } catch (error) {
    // Show line number if possible
    const match = error.message.match(/position (\d+)/);
    if (match) {
      const position = parseInt(match[1]);
      const lines = text.substring(0, position).split('\n');
      setError(`Invalid JSON at line ${lines.length}: ${error.message}`);
    } else {
      setError('Invalid JSON format: ' + error.message);
    }
  }
};
```

### Expected JSON Schemas
```typescript
// src/features/data-import/types/schemas.ts

interface TPNConfiguration {
  version: string;
  name: string;
  advisorType: 'NEO' | 'CHILD' | 'ADOLESCENT' | 'ADULT';
  ingredients: Ingredient[];
  calculations: any;
  settings: any;
}

interface IngredientsImport {
  version: string;
  ingredients: Array<{
    keyname: string;
    name: string;
    type: string;
    referenceRanges?: any[];
  }>;
}

interface ReferenceImport {
  version: string;
  reference: {
    name: string;
    healthSystem?: string;
    sections: Section[];
  };
}
```

### Validation Service
```typescript
// src/features/data-import/lib/validator.ts

export function validateImport(data: any): ValidationResult {
  // Check for known data types
  if (data.ingredients && Array.isArray(data.ingredients)) {
    return validateIngredients(data);
  }
  
  if (data.reference && data.reference.sections) {
    return validateReference(data);
  }
  
  if (data.advisorType && data.calculations) {
    return validateTPNConfig(data);
  }
  
  return {
    valid: false,
    error: 'Unknown data format. Expected ingredients, reference, or TPN configuration.'
  };
}
```

### Local Storage for Import History
```typescript
const saveToHistory = (importData: any) => {
  const history = JSON.parse(localStorage.getItem('importHistory') || '[]');
  history.unshift({
    timestamp: new Date().toISOString(),
    type: detectDataType(importData),
    name: importData.name || 'Unnamed import',
    data: importData
  });
  // Keep only last 10 imports
  history.splice(10);
  localStorage.setItem('importHistory', JSON.stringify(history));
};
```

### Export Functionality
```typescript
const exportData = (data: any, filename: string) => {
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${filename}_${Date.now()}.json`;
  link.click();
  URL.revokeObjectURL(url);
};
```

### Redux Integration
```typescript
// src/features/data-import/model/importSlice.ts
const importSlice = createSlice({
  name: 'import',
  initialState: {
    importing: false,
    error: null,
    lastImport: null,
    history: []
  },
  reducers: {
    importStart: (state) => {
      state.importing = true;
      state.error = null;
    },
    importSuccess: (state, action) => {
      state.importing = false;
      state.lastImport = {
        timestamp: Date.now(),
        type: action.payload.type,
        count: action.payload.count
      };
    },
    importError: (state, action) => {
      state.importing = false;
      state.error = action.payload;
    }
  }
});
```

### Material UI Components
```typescript
<Box>
  <ToggleButtonGroup value={mode} exclusive onChange={handleModeChange}>
    <ToggleButton value="file">
      <UploadFileIcon /> Upload File
    </ToggleButton>
    <ToggleButton value="paste">
      <ContentPasteIcon /> Paste JSON
    </ToggleButton>
  </ToggleButtonGroup>
  
  {mode === 'file' ? (
    <Button variant="contained" component="label">
      Select JSON File
      <input type="file" accept=".json" hidden onChange={handleFileUpload} />
    </Button>
  ) : (
    <TextField
      multiline
      rows={10}
      fullWidth
      placeholder="Paste JSON here..."
      value={pasteContent}
      onChange={(e) => setPasteContent(e.target.value)}
    />
  )}
</Box>
```

### Testing Requirements

#### Testing Standards
- Test file reading with valid and invalid files
- Test JSON parsing with various formats
- Test validation for each schema type
- Test Redux state updates
- Test import history in localStorage
- Test export functionality

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story as Firebase Storage | Scrum Master |
| 2025-09-05 | 2.0 | Complete revision to JSON import only | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_