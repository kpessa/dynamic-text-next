# Story 8.4: Ingredient Management Page

## Status
Ready for Development

## Story
**As a** pharmacist,
**I want** a comprehensive ingredient management interface,
**so that** I can view, edit, and organize all ingredients

## Acceptance Criteria
1. Searchable/filterable ingredient list
2. Grid and list view toggle
3. Ingredient detail panel (drawer)
4. Bulk selection and operations
5. Import/export buttons
6. Duplicate detection indicator
7. Category filters

## Tasks / Subtasks
- [ ] **Task 1: Create IngredientManagementPage** (AC: 1, 2, 7)
  - [ ] Create page at `src/app/(dashboard)/ingredients/manage/page.tsx`
  - [ ] Set up page layout with toolbar and content area
  - [ ] Add page header with title and actions
  - [ ] Implement responsive container
  - [ ] Connect to Redux for ingredient data
  - [ ] Write tests for page component

- [ ] **Task 2: Implement view mode toggle** (AC: 2)
  - [ ] Create ViewToggle component with list/grid icons
  - [ ] Add to toolbar with Material UI ToggleButtonGroup
  - [ ] Store view preference in localStorage
  - [ ] Create GridView component for card layout
  - [ ] Adapt existing DataTable for ListView
  - [ ] Implement smooth transition between views
  - [ ] Test view switching functionality

- [ ] **Task 3: Build ingredient detail drawer** (AC: 3)
  - [ ] Create Drawer component at `src/widgets/ingredient-drawer/ui/IngredientDrawer.tsx`
  - [ ] Design drawer layout with tabs (Details, History, Usage)
  - [ ] Display ingredient properties and metadata
  - [ ] Add edit mode with form validation
  - [ ] Include related ingredients section
  - [ ] Implement drawer animation
  - [ ] Test drawer open/close behavior

- [ ] **Task 4: Add search/filter functionality** (AC: 1, 7)
  - [ ] Use existing SearchBar component
  - [ ] Create FilterPanel at `src/widgets/ingredient-filters/ui/FilterPanel.tsx`
  - [ ] Implement category filter checkboxes
  - [ ] Add population type filters
  - [ ] Create status filters (active, deprecated, shared)
  - [ ] Implement filter combination logic
  - [ ] Add filter count badges
  - [ ] Test filter combinations

- [ ] **Task 5: Create bulk operations toolbar** (AC: 4)
  - [ ] Create BulkActions at `src/shared/ui/molecules/BulkActions/BulkActions.tsx`
  - [ ] Add checkbox column to DataTable
  - [ ] Implement select all/none functionality
  - [ ] Create bulk action buttons (Delete, Export, Share)
  - [ ] Add confirmation dialogs for destructive actions
  - [ ] Show selected count indicator
  - [ ] Test bulk selection logic

- [ ] **Task 6: Implement category sidebar** (AC: 7)
  - [ ] Create CategorySidebar component
  - [ ] Display category tree with counts
  - [ ] Add expand/collapse for subcategories
  - [ ] Implement category selection
  - [ ] Show active category highlighting
  - [ ] Add category management (add/edit/delete)
  - [ ] Test category navigation

- [ ] **Task 7: Add import/export functionality** (AC: 5)
  - [ ] Create import button with file upload
  - [ ] Support CSV, JSON, Excel formats
  - [ ] Implement import preview dialog
  - [ ] Add field mapping for imports
  - [ ] Create export menu with format options
  - [ ] Implement background export for large datasets
  - [ ] Test import/export workflows

- [ ] **Task 8: Implement duplicate detection** (AC: 6)
  - [ ] Create duplicate detection service
  - [ ] Add duplicate indicator badges
  - [ ] Implement merge suggestions dialog
  - [ ] Create duplicate resolution workflow
  - [ ] Add duplicate prevention on import
  - [ ] Test duplicate detection accuracy

## Dev Notes

### Previous Story Context
- Story 8.1-8.3: Application shell, dashboard, and TPN calculator pages established
- Story 5.2: Shared Ingredient Management feature implemented
- Story 5.3: Diff Viewer for comparing ingredients

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- **TypeScript**: 5.7+ with strict mode
- **Frontend Framework**: Next.js 15.5.2
- **UI Library**: Material UI 7.3.2
- **State Management**: Redux Toolkit 2.8.2
- **Database**: Firestore for ingredient storage

#### Project Structure [Source: architecture/source-tree.md]
Ingredient management location:
```
src/
├── app/(dashboard)/ingredients/
│   ├── manage/
│   │   └── page.tsx       # Management page (new)
│   ├── shared/           # Shared ingredients
│   └── import/           # Import wizard
├── widgets/
│   ├── ingredient-drawer/ # Detail drawer (new)
│   └── ingredient-filters/ # Filter panel (new)
├── features/ingredients/
│   ├── model/            # Redux state (exists)
│   ├── lib/              # Business logic
│   └── ui/               # Components
└── shared/ui/molecules/
    ├── BulkActions/      # Bulk operations (new)
    └── SearchBar/        # Search component (exists)
```

#### Data Models [Source: architecture/data-models.md]
```typescript
// Ingredient model from parent project
interface Ingredient {
  id: string;
  name: string;
  category: IngredientCategory;
  populationTypes: PopulationType[];
  unit: string;
  concentration?: number;
  minDose?: number;
  maxDose?: number;
  defaultDose?: number;
  isShared: boolean;
  healthSystem?: string;
  createdBy: string;
  createdAt: Date;
  modifiedAt: Date;
  version: number;
  status: 'active' | 'deprecated' | 'draft';
  metadata?: {
    supplier?: string;
    costPerUnit?: number;
    storageRequirements?: string;
    notes?: string;
  };
}

enum IngredientCategory {
  AMINO_ACIDS = 'amino_acids',
  LIPIDS = 'lipids',
  CARBOHYDRATES = 'carbohydrates',
  ELECTROLYTES = 'electrolytes',
  VITAMINS = 'vitamins',
  TRACE_ELEMENTS = 'trace_elements',
  MEDICATIONS = 'medications',
  ADDITIVES = 'additives'
}

interface IngredientFilter {
  searchTerm?: string;
  categories?: IngredientCategory[];
  populationTypes?: PopulationType[];
  status?: ('active' | 'deprecated' | 'draft')[];
  isShared?: boolean;
  healthSystem?: string;
}
```

#### Component Standards [Source: architecture/components.md]
- Use Material UI DataGrid for advanced features
- Implement virtual scrolling for large lists
- Follow responsive design patterns
- Use optimistic UI updates
- Maximum 500 lines per component

#### State Management [Source: architecture/frontend-architecture.md]
```typescript
// Ingredient management state
interface IngredientManagementState {
  ingredients: Ingredient[];
  selectedIds: Set<string>;
  filters: IngredientFilter;
  viewMode: 'list' | 'grid';
  sortBy: string;
  sortOrder: 'asc' | 'desc';
  isLoading: boolean;
  error: string | null;
  duplicates: Map<string, string[]>;
}
```

### Component Dependencies
**Existing Components to Use:**
- DataTable (shared/ui/organisms)
- SearchBar (shared/ui/molecules)
- Material UI: Drawer, Checkbox, Dialog

**New Components to Create:**
- IngredientDrawer - detail view widget
- FilterPanel - advanced filtering widget
- BulkActions - bulk operations toolbar
- CategorySidebar - category navigation

### Bulk Operations
1. **Delete** - Remove selected ingredients (with confirmation)
2. **Export** - Export selected to CSV/JSON
3. **Share** - Make ingredients available to other systems
4. **Duplicate** - Create copies with new names
5. **Change Category** - Bulk categorization
6. **Archive** - Move to deprecated status

### Import/Export Formats
- **CSV**: Flat structure for spreadsheets
- **JSON**: Complete object structure
- **Excel**: Multi-sheet with metadata
- **XML**: Legacy system compatibility

### Duplicate Detection Logic
```typescript
// Similarity checking
const checkDuplicates = (ingredient: Ingredient) => {
  // Check exact name match
  // Check similar names (Levenshtein distance)
  // Check same category + similar properties
  // Return similarity score and suggestions
};
```

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Test Location**: `__tests__` folders
- **Framework**: Vitest 3.2.4
- **Mock Strategy**: Mock Firestore operations

Key Test Scenarios:
1. List/grid view switching preserves selection
2. Filters combine correctly (AND logic)
3. Bulk operations affect only selected items
4. Import validates and maps fields correctly
5. Duplicate detection identifies similar items
6. Drawer shows correct ingredient details
7. Search works across all fields
8. Category navigation filters list

### Performance Considerations
- Virtual scrolling for >100 ingredients
- Debounce search input (300ms)
- Lazy load drawer content
- Cache filter results
- Batch bulk operations
- Paginate large exports

### Accessibility Requirements
- Keyboard navigation through list
- Screen reader announcements for filters
- Focus management in drawer
- Bulk selection keyboard shortcuts
- Clear labeling of all controls
- High contrast mode support

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
_To be populated by development agent_

### Agent Model Used
_To be populated_

### Debug Log References
_To be populated_

### Completion Notes List
_To be populated_

### File List
_To be populated_

## QA Results
_To be populated by QA agent_