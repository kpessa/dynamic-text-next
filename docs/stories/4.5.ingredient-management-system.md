# Story 4.5: Ingredient Management System

## Status
Ready for Development

## Story
**As a** healthcare professional,
**I want** a comprehensive ingredient management system for TPN calculations,
**so that** I can define, organize, and maintain ingredient data with reference ranges for different patient populations.

## Acceptance Criteria
1. Full CRUD operations for TPN ingredients
2. Reference ranges by population type (NEO, CHILD, ADOLESCENT, ADULT)
3. Ingredient categorization and typing
4. Import/export ingredients in JSON format
5. Bulk operations for multiple ingredients
6. Validation of ingredient data and ranges
7. Integration with TPN calculation engine
8. Search and filter capabilities

## Tasks / Subtasks
- [ ] **Task 1: Create Ingredient Data Model** (AC: 1, 2, 3)
  - [ ] Define Ingredient interface at `src/entities/ingredient/types/index.ts`
  - [ ] Create reference range types by population
  - [ ] Define ingredient categories (Macronutrient, Micronutrient, Additive, Salt, Diluent, Other)
  - [ ] Add concentration and unit definitions
  - [ ] Create validation rules for ingredient data
  - [ ] Define ingredient metadata (created, modified, version)

- [ ] **Task 2: Build Ingredient Service** (AC: 1, 7)
  - [ ] Create ingredient service at `src/features/ingredient-management/lib/ingredientService.ts`
  - [ ] Implement CRUD operations (create, read, update, delete)
  - [ ] Add ingredient validation logic
  - [ ] Create ingredient search functionality
  - [ ] Implement filtering by type and category
  - [ ] Add pagination support for large datasets

- [ ] **Task 3: Implement Reference Range Management** (AC: 2, 6)
  - [ ] Create reference range service at `src/features/ingredient-management/lib/referenceRangeService.ts`
  - [ ] Define threshold types (Feasible Low, Critical Low, Normal Low/High, Critical High, Feasible High)
  - [ ] Implement range validation by population type
  - [ ] Create range comparison utilities
  - [ ] Add range inheritance for missing population types
  - [ ] Build range conflict detection

- [ ] **Task 4: Create Import/Export System** (AC: 4)
  - [ ] Build import service at `src/features/ingredient-management/lib/importExportService.ts`
  - [ ] Parse ingredient JSON matching parent project structure
  - [ ] Validate imported data against schema
  - [ ] Handle duplicate detection on import
  - [ ] Create export formatting for different uses
  - [ ] Support selective import/export

- [ ] **Task 5: Implement Bulk Operations** (AC: 5)
  - [ ] Create bulk operations service at `src/features/ingredient-management/lib/bulkOperationsService.ts`
  - [ ] Implement bulk update functionality
  - [ ] Add bulk delete with confirmation
  - [ ] Create bulk validation
  - [ ] Support bulk range updates
  - [ ] Add transaction support for atomicity

- [ ] **Task 6: Build Redux Integration** (AC: All)
  - [ ] Create ingredient slice at `src/features/ingredient-management/model/ingredientSlice.ts`
  - [ ] Manage ingredient list in state
  - [ ] Track selected ingredients
  - [ ] Handle loading and error states
  - [ ] Create ingredient selectors
  - [ ] Add optimistic updates

- [ ] **Task 7: Create Ingredient UI Components** (AC: 1, 3, 8)
  - [ ] Build IngredientList component at `src/features/ingredient-management/ui/IngredientList.tsx`
  - [ ] Create IngredientEditor component for add/edit
  - [ ] Implement IngredientCard for display
  - [ ] Add IngredientSearch component
  - [ ] Build IngredientFilter component
  - [ ] Create IngredientBulkActions toolbar

- [ ] **Task 8: Implement Firebase Integration** (AC: 1, 7)
  - [ ] Create Firestore service at `src/features/ingredient-management/lib/firebaseIngredientService.ts`
  - [ ] Set up ingredients collection structure
  - [ ] Implement real-time synchronization
  - [ ] Add offline support with cache
  - [ ] Handle conflict resolution
  - [ ] Create backup/restore functionality

- [ ] **Task 9: Write Tests** (AC: All)
  - [ ] Unit tests for ingredient CRUD operations
  - [ ] Test reference range validation
  - [ ] Test import/export functionality
  - [ ] Test bulk operations
  - [ ] Integration tests with TPN calculations
  - [ ] Test Firebase synchronization
  - [ ] E2E tests for ingredient workflows

## Dev Notes

### Previous Story Context
From Story 4.1 (TPN Advisor Functions):
- TPNAdvisorType enum (NEO, CHILD, ADOLESCENT, ADULT)
- Integration needed with TPN calculation engine

From Story 4.3 (Formula Calculations):
- Variables from ingredients used in formulas
- Unit conversion needed for ingredient values

From Story 4.4 (TPN Document Generation):
- Ingredients exported in workspace configuration
- LoadedIngredient interface already defined

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- TypeScript 5.7+ with strict mode
- Redux Toolkit 2.8.2 for state management
- Firebase Firestore for persistence
- Material UI 7.3.2 for components
- Vitest 3.2.4 for testing

#### Project Structure [Source: architecture/source-tree.md]
- Ingredient feature: `/src/features/ingredient-management/`
- Ingredient entity: `/src/entities/ingredient/`
- Shared utilities: `/src/shared/lib/`
- Follow FSD layer dependencies

#### Data Models [Source: architecture/data-models.md]
```typescript
interface LoadedIngredient {
  id?: string;
  name: string;
  keyname?: string;
  type?: 'Macronutrient' | 'Micronutrient' | 'Additive' | 'Salt' | 'Diluent' | 'Other';
  referenceRanges?: ReferenceRange[];
  unit?: string;
  defaultValue?: number;
}
```

### Parent Project Ingredient Structure
From `../dynamic-text/src/lib/services/ingredientService.ts`:
```typescript
interface Ingredient {
  KEYNAME: string;          // Unique identifier
  DISPLAY: string;          // Display name
  MNEMONIC: string;         // Short code
  UOM_DISP: string;         // Unit of measure display
  TYPE: 'Macronutrient' | 'Micronutrient' | 'Additive' | 'Salt' | 'Diluent' | 'Other';
  OSMO_RATIO: number;
  EDITMODE: 'None' | 'Custom';
  PRECISION: number;        // Decimal places
  SPECIAL: string;
  NOTE: Array<{ TEXT: string }>;
  ALTUOM: Array<{ NAME: string; UOM_DISP: string }>;
  REFERENCE_RANGE: Array<{
    THRESHOLD: 'Feasible Low' | 'Critical Low' | 'Normal Low' | 'Normal High' | 'Critical High' | 'Feasible High';
    VALUE: number;
  }>;
  LABS: Array<{
    DISPLAY: string;
    EVENT_SET_NAME: string;
    GRAPH: 0 | 1;
  }>;
  CONCENTRATION: {
    STRENGTH: number;
    STRENGTH_UOM: string;
    VOLUME: number;
    VOLUME_UOM: string;
  };
  EXCLUDES: Array<{ keyname: string }>;
}
```

### Reference Range Management Pattern
```typescript
interface ReferenceRange {
  threshold: string;
  value: number;
  advisorType: TPNAdvisorType;
  unit: string;
  min?: number;
  max?: number;
}

class ReferenceRangeService {
  validateRange(
    value: number,
    ingredient: Ingredient,
    populationType: TPNAdvisorType
  ): RangeValidation {
    const ranges = this.getRangesForPopulation(ingredient, populationType);
    
    // Check against thresholds
    if (value < ranges.criticalLow) {
      return { status: 'critical-low', message: 'Below critical range' };
    }
    if (value > ranges.criticalHigh) {
      return { status: 'critical-high', message: 'Above critical range' };
    }
    // ... more checks
    
    return { status: 'normal', message: 'Within normal range' };
  }
}
```

### Bulk Operations Pattern
```typescript
interface BulkOperation {
  type: 'update' | 'delete' | 'validate';
  ingredientIds: string[];
  changes?: Partial<Ingredient>;
  options?: {
    skipValidation?: boolean;
    transaction?: boolean;
  };
}

class BulkOperationsService {
  async executeBulk(operation: BulkOperation): Promise<BulkResult> {
    const batch = writeBatch(db);
    
    try {
      for (const id of operation.ingredientIds) {
        // Apply operation
      }
      
      await batch.commit();
      return { success: true, processed: operation.ingredientIds.length };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
}
```

### Import/Export Format
```typescript
interface IngredientExport {
  version: string;
  exportDate: string;
  ingredients: Ingredient[];
  metadata: {
    count: number;
    populations: TPNAdvisorType[];
    categories: string[];
  };
}
```

### Firebase Collection Structure
```
/ingredients
  /{ingredientId}
    - ...ingredient fields
    - referenceRanges (subcollection)
      /{rangeId}
        - populationType
        - thresholds
        - values
```

### Search and Filter Implementation
```typescript
interface IngredientFilter {
  searchTerm?: string;
  types?: IngredientType[];
  populations?: TPNAdvisorType[];
  hasReferenceRanges?: boolean;
  modifiedAfter?: Date;
}

class IngredientSearchService {
  search(filter: IngredientFilter): Observable<Ingredient[]> {
    let query = collection(db, 'ingredients');
    
    if (filter.types?.length) {
      query = query.where('type', 'in', filter.types);
    }
    
    // Apply other filters...
    
    return collectionData(query);
  }
}
```

### Performance Considerations
- Paginate ingredient lists (20-50 items per page)
- Index frequently searched fields in Firestore
- Cache ingredient data locally
- Debounce search inputs (300ms)
- Use virtual scrolling for large lists

### Security Considerations
- Validate all ingredient data on import
- Sanitize HTML in ingredient notes
- Check user permissions for write operations
- Rate limit bulk operations
- Audit log for ingredient changes

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- Unit tests: 60% coverage minimum
- Integration tests: 20% coverage
- Test all CRUD operations
- Test range validation logic
- Test import/export roundtrip

#### Key Test Scenarios
- Create ingredient with all fields
- Update reference ranges
- Bulk update 100+ ingredients
- Import malformed JSON
- Search with complex filters
- Concurrent modifications
- Offline/online sync

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_