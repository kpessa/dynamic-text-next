# Story 4.4: TPN Document Generation

## Status
Ready for Development

## Story
**As a** healthcare professional,
**I want** to generate complete TPN documents that combine calculations, formulas, and dynamic text,
**so that** I can produce comprehensive nutritional reports for patient care.

## Acceptance Criteria
1. Document template system with sections
2. Integration of TPN calculations into documents
3. Dynamic text rendering with variable interpolation
4. Formula results embedded in document output
5. Document preview with live updates
6. Export configuration and ingredients as JSON (matching parent project structure)
7. Document versioning and history
8. HTML export with print-friendly styles

## Tasks / Subtasks
- [ ] **Task 1: Create Document Data Model** (AC: 1, 7)
  - [ ] Define Document types at `src/entities/document/types/index.ts`
  - [ ] Create document template interface
  - [ ] Define document section structure
  - [ ] Add version tracking metadata
  - [ ] Create document state interface
  - [ ] Define export format options

- [ ] **Task 2: Build Document Template System** (AC: 1)
  - [ ] Create template service at `src/features/document-generation/lib/templateService.ts`
  - [ ] Implement default TPN document templates
  - [ ] Support custom template creation
  - [ ] Handle template validation
  - [ ] Create template variable registry
  - [ ] Build template inheritance system

- [ ] **Task 3: Integrate TPN Calculations** (AC: 2, 4)
  - [ ] Create calculation integrator at `src/features/document-generation/lib/calculationIntegrator.ts`
  - [ ] Connect to TPN calculator from Story 4.1
  - [ ] Connect to formula engine from Story 4.3
  - [ ] Map calculation results to document variables
  - [ ] Handle calculation error states
  - [ ] Implement result formatting

- [ ] **Task 4: Implement Dynamic Text Rendering** (AC: 3)
  - [ ] Create renderer at `src/features/document-generation/lib/documentRenderer.ts`
  - [ ] Integrate with dynamic text editor from Story 4.2
  - [ ] Process static and dynamic sections
  - [ ] Execute embedded JavaScript code
  - [ ] Handle variable interpolation
  - [ ] Sanitize rendered output

- [ ] **Task 5: Build Document Preview Component** (AC: 5)
  - [ ] Create DocumentPreview widget at `src/widgets/document-preview/ui/DocumentPreview.tsx`
  - [ ] Implement split-view (editor/preview)
  - [ ] Add live preview updates (debounced)
  - [ ] Show calculation results in real-time
  - [ ] Display formatting and styles
  - [ ] Add zoom and navigation controls

- [ ] **Task 6: Create Export System** (AC: 6, 8)
  - [ ] Build export service at `src/features/document-generation/lib/exportService.ts`
  - [ ] Implement JSON configuration export matching parent project structure
  - [ ] Export ingredients list with reference ranges
  - [ ] Export sections array with test cases
  - [ ] Create HTML export with inline styles for printing
  - [ ] Add print stylesheet generation
  - [ ] Support import/export of complete workspace configurations

- [ ] **Task 7: Implement Document Versioning** (AC: 7)
  - [ ] Create version service at `src/features/document-generation/lib/versionService.ts`
  - [ ] Track document changes
  - [ ] Generate version diffs
  - [ ] Store version history in Firestore
  - [ ] Support version comparison
  - [ ] Implement version restore

- [ ] **Task 8: Build Redux Integration** (AC: All)
  - [ ] Create document slice at `src/features/document-generation/model/documentSlice.ts`
  - [ ] Manage active document state
  - [ ] Store document templates
  - [ ] Track preview settings
  - [ ] Handle export status
  - [ ] Create document selectors

- [ ] **Task 9: Create Document Management UI** (AC: All)
  - [ ] Build DocumentManager component at `src/features/document-generation/ui/DocumentManager.tsx`
  - [ ] Create new document workflow
  - [ ] List and search documents
  - [ ] Document actions (edit, preview, export, delete)
  - [ ] Version history viewer
  - [ ] Template selector

- [ ] **Task 10: Write Tests** (AC: All)
  - [ ] Unit tests for template system
  - [ ] Test calculation integration
  - [ ] Test dynamic text rendering
  - [ ] Test JSON export structure matches parent project
  - [ ] Test ingredient export with reference ranges
  - [ ] Test configuration import/export roundtrip
  - [ ] Test version tracking
  - [ ] Integration tests for document generation
  - [ ] E2E tests for complete workflow

## Dev Notes

### Previous Story Context

From Story 4.1 (TPN Advisor Functions):
- MockMe interface for calculation context
- TPNAdvisorType (NEO, CHILD, ADOLESCENT, ADULT)
- TPN calculation functions available
- TPNValues and TPNInstance types

From Story 4.2 (Dynamic Text Editor):
- Section types (static/dynamic)
- Dynamic code execution patterns
- Variable interpolation syntax `${variable}`
- Test case management system
- Safe sandboxed evaluation

From Story 4.3 (Formula Calculations):
- Formula parser and execution engine
- Variable resolution system
- Unit conversion capabilities
- Calculation caching
- Dependency resolution

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- TypeScript 5.7+ with strict mode
- Next.js 15.5.2 with Turbopack
- Redux Toolkit 2.8.2 for state management
- Material UI 7.3.2 for components
- Firebase (Firestore, Storage) for persistence
- Vitest 3.2.4 for testing

#### Project Structure [Source: architecture/source-tree.md]
- Document generation feature: `/src/features/document-generation/`
- Document entity: `/src/entities/document/`
- Preview widget: `/src/widgets/document-preview/`
- Shared utilities: `/src/shared/lib/`
- Follow FSD layer dependencies

#### Frontend Architecture [Source: architecture/frontend-architecture.md]
- Maximum 500 lines per component
- Redux store structure for document state
- Component organization follows FSD + Atomic Design

#### Core Workflows [Source: architecture/core-workflows.md]
- Dynamic code execution uses Web Workers
- Sandboxed execution with 5s timeout
- DOMPurify for sanitization

### Document Template Structure
```typescript
interface DocumentTemplate {
  id: string;
  name: string;
  description: string;
  sections: DocumentSection[];
  variables: VariableDefinition[];
  metadata: {
    version: string;
    author: string;
    createdAt: Date;
    updatedAt: Date;
  };
}

interface DocumentSection {
  id: string;
  type: 'header' | 'content' | 'calculation' | 'table' | 'footer';
  title?: string;
  content: string; // Can contain ${variables} and dynamic code
  order: number;
  visible: boolean;
  pageBreak?: boolean;
}

interface GeneratedDocument {
  id: string;
  templateId: string;
  title: string;
  sections: RenderedSection[];
  calculations: Record<string, any>;
  metadata: {
    generatedAt: Date;
    generatedBy: string;
    version: number;
    advisorType?: TPNAdvisorType;
  };
}
```

### Export Format Specifications

**JSON Configuration Export (Parent Project Compatible):**
```typescript
// Matches structure from ../dynamic-text/ Svelte project
interface WorkspaceExport {
  version: string;
  exportDate: string;
  ingredients: LoadedIngredient[];
  references: LoadedReference[];
  sections: Section[];
  tpnConfig: {
    advisorType: TPNAdvisorType;
    values: TPNValues;
    formulas: FormulaDefinition[];
  };
}

interface LoadedIngredient {
  id?: string;
  name: string;
  keyname?: string;
  type?: 'Macronutrient' | 'Micronutrient' | 'Additive' | 'Salt' | 'Diluent' | 'Other';
  referenceRanges?: ReferenceRange[];
  unit?: string;
  defaultValue?: number;
}

interface ReferenceRange {
  threshold: string;
  value: number;
  advisorType: TPNAdvisorType;
  unit: string;
  min?: number;
  max?: number;
}
```

**HTML Export:**
```typescript
interface HTMLExportOptions {
  includeStyles: boolean;
  inlineCSS: boolean;
  includeMetadata: boolean;
  printOptimized: boolean;
  pageBreaks: boolean;
}
```

**JSON Data Export:**
```typescript
interface JSONExportOptions {
  includeCalculations: boolean;
  includeIngredients: boolean;
  includeSections: boolean;
  includeTestCases: boolean;
  prettyPrint: boolean;
  format: 'workspace' | 'minimal' | 'complete';
}
```

### Parent Project Configuration Structure
```typescript
// Configuration structure from ../dynamic-text/ that needs to be maintained
interface ExportedWorkspace {
  // Ingredients with their reference ranges by advisor type
  ingredients: Array<{
    keyname: string;
    name: string;
    referenceRanges: Array<{
      advisorType: TPNAdvisorType;
      min: number;
      max: number;
      unit: string;
    }>;
  }>;
  
  // Document sections with embedded calculations
  sections: Array<{
    id: number;
    type: 'static' | 'dynamic';
    name: string;
    content: string;
    testCases: TestCase[];
  }>;
  
  // TPN configuration and formulas
  config: {
    advisorType: TPNAdvisorType;
    formulas: Record<string, string>;
    values: Record<string, any>;
  };
}
```

### Document Generation Flow
```typescript
class DocumentGenerator {
  async generate(
    template: DocumentTemplate,
    context: DocumentContext
  ): Promise<GeneratedDocument> {
    // 1. Load template
    const loadedTemplate = await this.templateService.load(template.id);
    
    // 2. Gather TPN calculations
    const calculations = await this.calculationIntegrator.execute(
      context.tpnInstance,
      context.advisorType
    );
    
    // 3. Execute formulas
    const formulaResults = await this.formulaEngine.calculateAll(
      template.variables,
      { ...context, ...calculations }
    );
    
    // 4. Render sections
    const renderedSections = await this.renderer.renderAll(
      template.sections,
      { ...context, ...calculations, ...formulaResults }
    );
    
    // 5. Generate document
    return {
      id: generateId(),
      templateId: template.id,
      title: this.interpolate(template.name, context),
      sections: renderedSections,
      calculations: { ...calculations, ...formulaResults },
      metadata: this.generateMetadata(context)
    };
  }
}
```

### Library Recommendations

**JSON Export/Import:**
- Native JSON.stringify/parse for data serialization
- Validation using TypeScript interfaces
- Consider using zod or yup for runtime validation of imported configurations

**HTML Generation:**
- Use React's renderToStaticMarkup for server-side HTML generation
- DOMPurify for sanitizing dynamic content
- Inline styles using style objects for print optimization

### Performance Considerations
- Debounce preview updates (500ms)
- Cache rendered sections
- Lazy load export libraries
- Use Web Workers for heavy rendering
- Optimize images before embedding

### Security Considerations
- Sanitize all dynamic content with DOMPurify
- Validate template variables
- Limit document size (10MB max)
- Rate limit export operations
- Validate file types for embedded content

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- Unit tests: 60% coverage minimum
- Integration tests: 20% coverage
- E2E tests for critical workflows
- Co-locate tests with source files

#### Key Test Scenarios
- Template validation and loading
- Calculation integration accuracy
- Dynamic text rendering safety
- JSON export structure matches parent project format
- Ingredient export includes all reference ranges
- Configuration roundtrip (export â†’ import) preserves all data
- HTML export is print-optimized
- Version tracking consistency
- Preview update performance
- Error handling in generation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-05 | 1.1 | Removed PDF export, focus on JSON config export matching parent project | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_