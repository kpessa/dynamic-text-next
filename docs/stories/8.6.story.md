# Story 8.6: Comparison/Diff Viewer Page

## Status
Ready for Development

## Story
**As a** reviewer,
**I want** a dedicated page for comparing ingredients,
**so that** I can analyze differences effectively

## Acceptance Criteria
1. Full-screen diff viewer layout
2. Population/version selector
3. Side-by-side and unified view toggle
4. Export comparison results
5. Navigation between differences
6. Highlight controls

## Tasks / Subtasks
- [ ] **Task 1: Create ComparisonPage layout** (AC: 1)
  - [ ] Create page at `src/app/compare/page.tsx`
  - [ ] Design full-screen layout optimized for comparisons
  - [ ] Add header with comparison controls
  - [ ] Implement responsive design for mobile
  - [ ] Create breadcrumb navigation
  - [ ] Write tests for page layout

- [ ] **Task 2: Integrate DiffViewer components** (AC: 2, 3)
  - [ ] Import DiffViewer from `src/features/diff-viewer`
  - [ ] Import DiffControls from feature layer
  - [ ] Connect to Redux for diff state
  - [ ] Implement population selector integration
  - [ ] Add version selector functionality
  - [ ] Test component integration

- [ ] **Task 3: Add view mode controls** (AC: 3)
  - [ ] Create view toggle (side-by-side vs unified)
  - [ ] Use Material UI ToggleButtonGroup
  - [ ] Store view preference in localStorage
  - [ ] Implement smooth transition between views
  - [ ] Add keyboard shortcuts for view switching
  - [ ] Test view mode changes

- [ ] **Task 4: Implement diff navigation** (AC: 5)
  - [ ] Add next/previous difference buttons
  - [ ] Create diff summary stats (X additions, Y deletions)
  - [ ] Implement jump-to-difference functionality
  - [ ] Add keyboard navigation (n/p for next/prev)
  - [ ] Create minimap for large diffs
  - [ ] Test navigation features

- [ ] **Task 5: Create export functionality** (AC: 4)
  - [ ] Add export menu button
  - [ ] Implement PDF export with formatting
  - [ ] Add CSV export for data analysis
  - [ ] Create HTML export with embedded styles
  - [ ] Include clipboard copy option
  - [ ] Test all export formats

- [ ] **Task 6: Add highlight controls** (AC: 6)
  - [ ] Create highlight toggle buttons
  - [ ] Implement color customization
  - [ ] Add highlight granularity (line/word/char)
  - [ ] Create highlight legend
  - [ ] Store highlight preferences
  - [ ] Test highlight functionality

- [ ] **Task 7: Implement comparison presets** (AC: 2)
  - [ ] Create quick comparison buttons
  - [ ] Add "Compare All Populations" preset
  - [ ] Implement "Latest vs Previous Version" preset
  - [ ] Create custom comparison save/load
  - [ ] Test preset functionality

## Dev Notes

### Previous Story Context
- Story 5.3: Diff Viewer components already implemented
- Stories 8.1-8.5: Core application structure in place
- No auth required per user requirement

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- **TypeScript**: 5.7+ with strict mode
- **Frontend Framework**: Next.js 15.5.2
- **UI Library**: Material UI 7.3.2
- **Diff Library**: diff2html (from Story 5.3)

#### Project Structure [Source: architecture/source-tree.md]
Comparison page location:
```
src/
├── app/
│   └── compare/
│       └── page.tsx       # Comparison page (new)
├── features/diff-viewer/
│   ├── ui/               # Diff components (exists)
│   ├── lib/              # Diff engine (exists)
│   └── model/            # Redux state (exists)
└── shared/ui/
    └── molecules/
        └── ExportMenu/   # Export options (new)
```

#### Data Models [Source: Story 5.3]
```typescript
interface DiffComparison {
  id: string;
  ingredientId: string;
  mode: 'populations' | 'versions';
  selections: {
    populations?: Set<PopulationType>;
    version1?: number;
    version2?: number;
  };
  results: DiffResult[];
}

interface DiffOptions {
  viewMode: 'side-by-side' | 'unified';
  showIdentical: boolean;
  granularity: 'line' | 'word' | 'char';
  highlightChanges: boolean;
}
```

### Component Dependencies
**Existing Components from Story 5.3:**
- DiffViewer - Main diff display
- DiffControls - Control panel
- DiffViewerModal - Modal wrapper
- SideBySideView - Split view
- UnifiedView - Unified diff view

**New Components Needed:**
- ComparisonPresets - Quick comparison buttons
- DiffNavigator - Navigation controls
- ExportMenu - Export options

### Comparison Presets
1. **All Populations** - Compare NEO, CHILD, ADOLESCENT, ADULT
2. **Version History** - Compare versions chronologically
3. **Cross-System** - Compare across health systems
4. **Custom** - User-defined comparisons

### Export Formats
- **PDF**: Full report with highlighting
- **CSV**: Tabular diff data
- **HTML**: Standalone page with styles
- **JSON**: Structured diff data
- **Clipboard**: Quick copy of changes

### Navigation Features
```typescript
interface DiffNavigation {
  totalChanges: number;
  currentChange: number;
  additions: number;
  deletions: number;
  modifications: number;
}
```

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Test Location**: `__tests__` folders
- **Framework**: Vitest 3.2.4

Key Test Scenarios:
1. Page loads with diff viewer
2. View modes switch correctly
3. Navigation moves between differences
4. Export generates valid files
5. Highlights apply correctly
6. Presets load correct comparisons
7. Mobile layout responsive

### Performance Considerations
- Virtualize large diffs (>1000 lines)
- Lazy load diff2html library
- Cache comparison results
- Debounce view updates

### Accessibility Requirements
- Keyboard navigation through diffs
- Screen reader announcements for changes
- High contrast mode for highlights
- Focus management in controls
- ARIA labels for all buttons

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
_To be populated by development agent_

### Agent Model Used
_To be populated_

### Debug Log References
_To be populated_

### Completion Notes List
_To be populated_

### File List
_To be populated_

## QA Results
_To be populated by QA agent_