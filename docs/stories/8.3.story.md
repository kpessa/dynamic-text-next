# Story 8.3: TPN Calculator Page

## Status
Ready for Development

## Story
**As a** clinician,
**I want** a dedicated page for TPN calculations,
**so that** I have space for inputs and results

## Acceptance Criteria
1. Full-page layout with input panel and results
2. Population type selector prominent
3. Input fields organized by category
4. Real-time validation feedback
5. Results table with export options
6. Save/load calculation functionality
7. Mobile-responsive layout

## Tasks / Subtasks
- [ ] **Task 1: Create TPNCalculatorPage layout** (AC: 1, 7)
  - [ ] Create page at `src/app/(dashboard)/tpn/calculator/page.tsx`
  - [ ] Design two-column layout (inputs left, results right)
  - [ ] Implement responsive breakpoint (stack on mobile)
  - [ ] Add page title and description
  - [ ] Set up container with proper spacing
  - [ ] Write tests for layout rendering

- [ ] **Task 2: Organize TPNCalculator into sections** (AC: 3)
  - [ ] Integrate existing TPNCalculator from `src/features/tpn-calculations`
  - [ ] Create collapsible sections for input categories
  - [ ] Group inputs: Patient Info, Nutritional Requirements, Medications
  - [ ] Add section headers with icons
  - [ ] Implement expand/collapse functionality
  - [ ] Style with Material UI Accordion

- [ ] **Task 3: Implement population selector** (AC: 2)
  - [ ] Create prominent population type selector at top
  - [ ] Use Material UI ToggleButtonGroup or Tabs
  - [ ] Display population-specific icons and colors
  - [ ] Update form fields based on population selection
  - [ ] Persist selection in Redux state
  - [ ] Add visual indicators for active population

- [ ] **Task 4: Add validation error display** (AC: 4)
  - [ ] Implement real-time field validation
  - [ ] Display inline error messages under fields
  - [ ] Add error summary panel
  - [ ] Highlight invalid fields with red border
  - [ ] Show validation rules on field focus
  - [ ] Create validation helper tooltips
  - [ ] Test validation scenarios

- [ ] **Task 5: Implement results visualization** (AC: 5)
  - [ ] Use existing DataTable component for results
  - [ ] Add result categories (Macros, Micros, Additives)
  - [ ] Implement color coding for values
  - [ ] Add units and precision formatting
  - [ ] Create expandable detail rows
  - [ ] Include calculation methodology notes

- [ ] **Task 6: Create save/load UI** (AC: 6)
  - [ ] Add save button with name dialog
  - [ ] Create load dropdown with saved calculations
  - [ ] Implement auto-save draft functionality
  - [ ] Add timestamp to saved calculations
  - [ ] Show save status indicator
  - [ ] Handle save conflicts
  - [ ] Test save/load workflow

- [ ] **Task 7: Add export functionality** (AC: 5)
  - [ ] Create export menu with format options
  - [ ] Implement PDF export with patient header
  - [ ] Add CSV export for data analysis
  - [ ] Create clipboard copy function
  - [ ] Include export timestamp
  - [ ] Test export formats

- [ ] **Task 8: Test responsive breakpoints** (AC: 7)
  - [ ] Verify layout at 320px (mobile)
  - [ ] Test at 768px (tablet)
  - [ ] Check 1024px (desktop)
  - [ ] Validate at 1440px (wide)
  - [ ] Ensure touch targets are 44px minimum
  - [ ] Test form usability on mobile

## Dev Notes

### Previous Story Context
- Story 8.1: Created application shell with navigation
- Story 8.2: Implemented dashboard with quick actions linking here

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- **TypeScript**: 5.7+ with strict mode
- **Frontend Framework**: Next.js 15.5.2
- **UI Library**: Material UI 7.3.2
- **State Management**: Redux Toolkit 2.8.2
- **Form Validation**: React Hook Form (if needed)

#### Project Structure [Source: architecture/source-tree.md]
TPN Calculator page location:
```
src/
├── app/(dashboard)/tpn/
│   └── calculator/
│       └── page.tsx        # Calculator page (new)
├── features/tpn-calculations/
│   ├── ui/                # Calculator components (exists)
│   ├── model/             # Calculation logic (exists)
│   └── index.ts
└── shared/ui/
    └── organisms/
        └── DataTable/     # Results table (exists)
```

#### Data Models [Source: architecture/data-models.md]
```typescript
// TPN Calculation types from parent project
interface TPNCalculation {
  id: string;
  patientId: string;
  populationType: PopulationType;
  inputs: TPNInputs;
  results: TPNResults;
  timestamp: Date;
  savedName?: string;
  status: 'draft' | 'completed';
}

interface TPNInputs {
  weight: number;
  height: number;
  age: number;
  stressFactor: number;
  proteinRequirement: number;
  // Population-specific fields
  gestationalAge?: number;  // Neonatal
  growthPercentile?: number; // Pediatric
}

interface TPNResults {
  totalCalories: number;
  proteinGrams: number;
  carbGrams: number;
  lipidGrams: number;
  electrolyteRequirements: Record<string, number>;
  vitamins: Record<string, number>;
  traceElements: Record<string, number>;
}

const POPULATION_TYPES = {
  NEO: 'neonatal',
  CHILD: 'child', 
  ADOLESCENT: 'adolescent',
  ADULT: 'adult'
} as const;
```

#### Component Standards [Source: architecture/components.md]
- Use Material UI form components
- Implement field-level validation
- Follow WCAG 2.1 AA for forms
- Use React.memo for expensive calculations
- Maximum 500 lines per component

#### Validation Rules [Source: Parent Project]
```typescript
// Field validation rules by population
const validationRules = {
  neonatal: {
    weight: { min: 0.5, max: 10, unit: 'kg' },
    gestationalAge: { min: 22, max: 44, unit: 'weeks' }
  },
  child: {
    weight: { min: 3, max: 40, unit: 'kg' },
    age: { min: 0.1, max: 12, unit: 'years' }
  },
  adolescent: {
    weight: { min: 25, max: 100, unit: 'kg' },
    age: { min: 12, max: 18, unit: 'years' }
  },
  adult: {
    weight: { min: 40, max: 200, unit: 'kg' },
    age: { min: 18, max: 120, unit: 'years' }
  }
};
```

### Component Dependencies
**Existing Components to Use:**
- TPNCalculator (features/tpn-calculations)
- DataTable (shared/ui/organisms)
- Select, Input, Alert (shared/ui/atoms)
- FormField (shared/ui/molecules)
- Material UI: Accordion, ToggleButtonGroup

**New Components Needed:**
- Section organizers for input groups
- Export menu component
- Save/load dialog

### Input Categories
1. **Patient Information**
   - Weight, Height, Age
   - Population-specific (gestational age, etc.)

2. **Nutritional Requirements**
   - Calories per kg
   - Protein requirements
   - Fluid requirements

3. **Medications & Additives**
   - Insulin requirements
   - Heparin
   - Additional medications

### Export Formats
- **PDF**: Full report with header, inputs, results
- **CSV**: Tabular data for analysis
- **JSON**: Complete calculation object
- **Clipboard**: Quick copy of results

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Test Location**: Adjacent `__tests__` folders
- **Framework**: Vitest 3.2.4
- **Coverage**: 80% for calculation logic

Key Test Scenarios:
1. Population switching updates form fields
2. Validation prevents invalid inputs
3. Calculations produce correct results
4. Save/load preserves all data
5. Export generates valid files
6. Responsive layout works on mobile
7. Keyboard navigation through form
8. Error messages display correctly

### Performance Considerations
- Debounce calculation triggers (150ms)
- Memoize expensive calculations
- Lazy load export libraries
- Cache saved calculations locally

### Accessibility Requirements
- Label all form fields clearly
- Provide field descriptions
- Keyboard navigation support
- Error announcements for screen readers
- Focus management on validation errors
- High contrast mode support

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
_To be populated by development agent_

### Agent Model Used
_To be populated_

### Debug Log References
_To be populated_

### Completion Notes List
_To be populated_

### File List
_To be populated_

## QA Results
_To be populated by QA agent_