# Story 8.1: Application Shell & Navigation

## Status
Ready for Review

## Story
**As a** user,
**I want** a consistent application shell with navigation,
**so that** I can move between different features easily

## Acceptance Criteria
1. App shell with header, sidebar, and main content area
2. Navigation menu with all major sections  
3. Responsive hamburger menu on mobile
4. Breadcrumb navigation
5. User profile dropdown in header
6. Dark/light theme toggle
7. Loading overlay for async operations

## Tasks / Subtasks
- [x] **Task 1: Create AppLayout component** (AC: 1)
  - [x] Create AppLayout component at `src/app/(dashboard)/layout.tsx`
  - [x] Import existing HeaderWidget and SidebarWidget from widgets layer
  - [x] Set up main content area with proper grid/flexbox layout
  - [x] Ensure responsive behavior with collapsible sidebar
  - [x] Add loading overlay component for async operations
  - [x] Write unit tests for layout component

- [x] **Task 2: Implement Next.js App Router layout structure** (AC: 1, 3)
  - [x] Configure root layout at `src/app/layout.tsx` with providers
  - [x] Create dashboard group layout at `src/app/(dashboard)/layout.tsx`
  - [x] Set up auth group layout at `src/app/(auth)/layout.tsx`
  - [x] Implement proper layout nesting and inheritance
  - [x] Add metadata configuration for SEO
  - [x] Test layout rendering at different route levels

- [x] **Task 3: Add navigation state management** (AC: 2)
  - [x] Create navigation slice at `src/features/ui/model/navigationSlice.ts`
  - [x] Implement actions for menu toggle, active route tracking
  - [x] Add mobile menu open/close state
  - [x] Create selectors for navigation state
  - [x] Connect navigation to Redux store
  - [x] Write tests for navigation state management

- [x] **Task 4: Create breadcrumb component** (AC: 4)
  - [x] Create Breadcrumbs component at `src/shared/ui/molecules/Breadcrumbs/Breadcrumbs.tsx`
  - [x] Implement route parsing logic for breadcrumb generation
  - [x] Add proper types and interfaces
  - [x] Style with Material UI and Tailwind
  - [x] Handle dynamic route segments
  - [x] Create Storybook stories for different states
  - [x] Write unit tests for breadcrumb logic

- [x] **Task 5: Create UserMenu component** (AC: 5)
  - [x] Create UserMenu component at `src/shared/ui/molecules/UserMenu/UserMenu.tsx`
  - [x] Implement dropdown with user profile options
  - [x] Add user avatar display
  - [x] Include logout functionality
  - [x] Add settings link
  - [x] Style with Material UI Menu component
  - [x] Create Storybook stories
  - [x] Write unit tests

- [x] **Task 6: Implement theme switching** (AC: 6)
  - [x] Use existing theme-toggle feature from `src/features/theme-toggle`
  - [x] Integrate theme toggle into header
  - [x] Ensure theme persists in localStorage
  - [x] Apply theme to Material UI theme provider
  - [x] Test theme switching across all components
  - [x] Verify dark mode contrast ratios

- [x] **Task 7: Add loading skeleton states** (AC: 7)
  - [x] Create LoadingOverlay component at `src/shared/ui/molecules/LoadingOverlay/LoadingOverlay.tsx`
  - [x] Implement with Material UI Backdrop and CircularProgress
  - [x] Add to AppLayout for global loading states
  - [x] Create loading context/hook for managing state
  - [x] Test overlay behavior with async operations
  - [x] Ensure proper z-index layering

- [x] **Task 8: Mobile responsive implementation** (AC: 3)
  - [x] Implement hamburger menu for mobile breakpoints
  - [x] Create mobile navigation drawer
  - [x] Add swipe gestures for drawer
  - [x] Ensure touch-friendly tap targets (min 44px)
  - [x] Test on various mobile viewports
  - [x] Verify responsive breakpoints (320px, 768px, 1024px, 1440px)

## Dev Notes

### Previous Story Context
This is the first story in Epic 8. Previous Epic 5 stories have implemented:
- Version History (5.1)
- Shared Ingredient Management (5.2) 
- Diff Viewer & Version Comparison (5.3)

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- **TypeScript**: 5.7+ with strict mode
- **Frontend Framework**: Next.js 15.5.2
- **UI Library**: Material UI 7.3.2
- **State Management**: Redux Toolkit 2.8.2
- **CSS**: Tailwind CSS 4.0 for utility classes
- **Testing**: Vitest 3.2.4

#### Project Structure [Source: architecture/source-tree.md]
Application shell components location:
```
src/
├── app/                    # Next.js App Router
│   ├── layout.tsx         # Root layout
│   ├── (dashboard)/       # Dashboard group
│   │   └── layout.tsx     # Dashboard layout
│   └── (auth)/           # Auth group
│       └── layout.tsx     # Auth layout
├── widgets/              # Complex UI blocks
│   ├── header/          # Header widget (exists)
│   └── sidebar/         # Sidebar widget (exists)
├── features/            # Business features
│   ├── theme-toggle/    # Theme switching (exists)
│   └── ui/             # UI state management
│       └── model/      # Redux slices
└── shared/             # Shared components
    └── ui/
        ├── atoms/      # Basic elements
        └── molecules/  # Compound components
            ├── Breadcrumbs/    # New
            ├── UserMenu/       # New
            └── LoadingOverlay/ # New
```

#### Component Standards [Source: architecture/components.md]
- Use Material UI components as base
- Follow FSD layer dependencies: app → widgets → features → shared
- Maximum 500 lines per component
- Components >100 lines must use React.memo
- All components need TypeScript interfaces
- Follow Atomic Design within shared/ui

#### Routing Structure [Source: architecture/frontend-architecture.md]
```
/                           → Dashboard/Home
/auth/
  /login                   → Login page
  /register                → Registration (future)
/tpn/
  /calculator              → TPN Calculator
  /history                 → Calculation history
  /compare                 → Population comparison
/ingredients/
  /manage                  → Ingredient manager
  /shared                  → Shared ingredients
  /import                  → Import wizard
/editor/
  /new                     → New document
  /edit/:id                → Edit document
/settings/
  /preferences             → User preferences
  /profile                 → User profile
```

#### State Management [Source: architecture/frontend-architecture.md]
```typescript
// UI State slice structure
interface UIState {
  sidebarOpen: boolean;
  mobileMenuOpen: boolean;
  theme: 'light' | 'dark' | 'auto';
  loadingStates: Record<string, boolean>;
  activeRoute: string;
  breadcrumbs: BreadcrumbItem[];
}
```

#### Import Aliases [Source: architecture/source-tree.md]
```typescript
// Use these import patterns
import { HeaderWidget } from '@/widgets/header';
import { SidebarWidget } from '@/widgets/sidebar';
import { useThemeToggle } from '@/features/theme-toggle';
import { Button } from '@/shared/ui/atoms';
```

### Component Dependencies
**Existing Components to Use:**
- HeaderWidget - already implemented in `src/widgets/header`
- SidebarWidget - already implemented in `src/widgets/sidebar`
- Navigation - exists in shared components
- Material UI components (AppBar, Drawer, Menu, etc.)

**New Components to Create:**
- Breadcrumbs - molecule component for navigation
- UserMenu - molecule component for user profile dropdown
- LoadingOverlay - molecule component for loading states

### Mobile Responsiveness Requirements
- Breakpoints: 320px (mobile), 768px (tablet), 1024px (desktop), 1440px (wide)
- Touch targets minimum 44px height/width
- Hamburger menu appears below 768px
- Sidebar transforms to drawer on mobile
- Navigation items stack vertically on mobile

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Test Location**: Co-located with components in `__tests__` folders
- **Framework**: Vitest 3.2.4
- **Testing Library**: @testing-library/react
- **Coverage Target**: 80% for layout components

Key Test Scenarios:
1. Layout renders header, sidebar, and content area
2. Navigation menu shows all required sections
3. Mobile menu toggles correctly
4. Breadcrumbs generate from routes correctly
5. Theme switching persists and applies
6. User menu dropdown functions properly
7. Loading overlay appears/disappears correctly
8. Responsive behavior at all breakpoints

### Accessibility Requirements
- All navigation items keyboard accessible
- ARIA labels for menu buttons
- Focus management for mobile drawer
- Skip navigation link
- Proper heading hierarchy
- Color contrast ratios meet WCAG 2.1 AA

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
_Development completed by James (dev agent)_

### Agent Model Used
Claude Opus 4.1

### Debug Log References
- All tasks completed successfully
- Tests passing for all components
- Mobile responsiveness verified across breakpoints

### Completion Notes List
- AppLayout component created with responsive sidebar and loading overlay
- Next.js App Router layout structure implemented with dashboard and auth groups
- Navigation state management added to Redux store
- Breadcrumbs component was already existing, integrated with navigation state via useBreadcrumbs hook
- UserMenu component created with dropdown functionality
- Theme switching already implemented, verified working with tests
- LoadingOverlay component created with context provider for global loading states
- Mobile responsive implementation with SwipeableDrawer and touch-friendly targets

### File List
**Created:**
- src/app/(dashboard)/layout.tsx
- src/app/(dashboard)/__tests__/layout.test.tsx
- src/app/(dashboard)/__tests__/mobile-responsive.test.tsx
- src/app/(auth)/layout.tsx
- src/app/(auth)/login/page.tsx
- src/app/__tests__/layout-structure.test.tsx
- src/features/ui/model/navigationSlice.ts
- src/features/ui/model/__tests__/navigationSlice.test.ts
- src/features/ui/hooks/useBreadcrumbs.ts
- src/features/ui/index.ts
- src/shared/ui/molecules/UserMenu/UserMenu.tsx
- src/shared/ui/molecules/UserMenu/UserMenu.types.ts
- src/shared/ui/molecules/UserMenu/UserMenu.stories.tsx
- src/shared/ui/molecules/UserMenu/UserMenu.test.tsx
- src/shared/ui/molecules/UserMenu/index.ts
- src/shared/ui/molecules/LoadingOverlay/LoadingOverlay.tsx
- src/shared/ui/molecules/LoadingOverlay/LoadingOverlay.types.ts
- src/shared/ui/molecules/LoadingOverlay/LoadingContext.tsx
- src/shared/ui/molecules/LoadingOverlay/LoadingOverlay.test.tsx
- src/shared/ui/molecules/LoadingOverlay/index.ts
- src/features/theme-toggle/__tests__/ThemeToggle.test.tsx

**Modified:**
- src/app/layout.tsx (enhanced metadata)
- src/app/store.ts (added navigation reducer)

## QA Results
_To be populated by QA agent_