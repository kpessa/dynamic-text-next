# Story 4.3: Formula Calculations

## Status
Ready for Development

## Story
**As a** healthcare professional,
**I want** a robust formula calculation engine that processes TPN formulas with mathematical expressions,
**so that** I can generate accurate nutritional calculations for different patient populations.

## Acceptance Criteria
1. Mathematical expression parser for formulas
2. Support for standard math operations (+, -, *, /, ^, parentheses)
3. Math function support (min, max, round, floor, ceil, abs)
4. Variable substitution from TPN context
5. Unit conversion during calculations
6. Formula validation and error handling
7. Calculation caching for performance
8. Formula dependency resolution

## Tasks / Subtasks
- [ ] **Task 1: Create Formula Parser Module** (AC: 1, 2, 3)
  - [ ] Install math expression parser library (mathjs or expr-eval)
  - [ ] Create parser service at `src/features/tpn-calculations/lib/formulaParser.ts`
  - [ ] Implement safe expression evaluation with sandboxing
  - [ ] Support standard operators and precedence
  - [ ] Handle parentheses and nested expressions
  - [ ] Add math function support (min, max, round, etc.)

- [ ] **Task 2: Build Variable Resolution System** (AC: 4)
  - [ ] Create variable resolver at `src/features/tpn-calculations/lib/variableResolver.ts`
  - [ ] Implement variable lookup from TPN context
  - [ ] Handle nested object property access (e.g., patient.weight)
  - [ ] Support array indexing for multi-value fields
  - [ ] Provide default values for missing variables
  - [ ] Create variable validation before evaluation

- [ ] **Task 3: Implement Unit Conversion Engine** (AC: 5)
  - [ ] Create unit converter at `src/shared/lib/unitConverter.ts`
  - [ ] Define unit conversion map (kg/lb, cm/in, etc.)
  - [ ] Support automatic unit detection in formulas
  - [ ] Handle conversion within expressions
  - [ ] Maintain precision during conversions
  - [ ] Create unit validation helpers

- [ ] **Task 4: Create Formula Validation Service** (AC: 6)
  - [ ] Build validator at `src/features/tpn-calculations/lib/formulaValidator.ts`
  - [ ] Check formula syntax before execution
  - [ ] Validate variable references exist
  - [ ] Detect circular dependencies
  - [ ] Validate math function arguments
  - [ ] Return detailed error messages
  - [ ] Create formula complexity analysis

- [ ] **Task 5: Build Calculation Cache System** (AC: 7)
  - [ ] Create cache service at `src/features/tpn-calculations/lib/calculationCache.ts`
  - [ ] Implement LRU cache for calculation results
  - [ ] Generate cache keys from formula + variables
  - [ ] Handle cache invalidation on variable changes
  - [ ] Configure TTL for cached results
  - [ ] Add cache hit/miss metrics

- [ ] **Task 6: Implement Dependency Resolution** (AC: 8)
  - [ ] Create dependency resolver at `src/features/tpn-calculations/lib/dependencyResolver.ts`
  - [ ] Build dependency graph from formulas
  - [ ] Implement topological sort for execution order
  - [ ] Detect and handle circular dependencies
  - [ ] Support conditional dependencies
  - [ ] Optimize execution path

- [ ] **Task 7: Create Formula Execution Engine** (AC: All)
  - [ ] Build main engine at `src/features/tpn-calculations/lib/formulaEngine.ts`
  - [ ] Integrate parser, resolver, converter, validator
  - [ ] Execute formulas in dependency order
  - [ ] Handle batch formula execution
  - [ ] Collect and format results
  - [ ] Implement error recovery strategies

- [ ] **Task 8: Build Redux Integration** (AC: All)
  - [ ] Extend TPN slice at `src/features/tpn-calculations/model/tpnSlice.ts`
  - [ ] Add formula calculation actions
  - [ ] Store calculation results in state
  - [ ] Track calculation errors
  - [ ] Manage formula definitions
  - [ ] Create selectors for formula results

- [ ] **Task 9: Write Comprehensive Tests** (AC: All)
  - [ ] Unit tests for formula parser with complex expressions
  - [ ] Test variable resolution with nested properties
  - [ ] Test unit conversions accuracy
  - [ ] Test formula validation edge cases
  - [ ] Test cache behavior and invalidation
  - [ ] Test dependency resolution algorithms
  - [ ] Integration tests for complete calculation flows
  - [ ] Performance tests for complex formula sets

## Dev Notes

### Previous Story Context
From Story 4.1 (TPN Advisor Functions):
- MockMe interface established for calculation context
- TPNAdvisorType enum defined (NEO, CHILD, ADOLESCENT, ADULT)
- Basic calculation patterns implemented
- getValue, maxP, calculate methods available

From Story 4.2 (Dynamic Text Editor):
- Section types support dynamic code execution
- Expression evaluation patterns established
- Variable interpolation syntax (${variable})
- Safe sandboxed execution using Function constructor

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- TypeScript 5.7+ with strict mode
- Redux Toolkit 2.8.2 for state management
- Vitest 3.2.4 for testing
- Next.js 15.5.2 with Turbopack

#### Project Structure [Source: architecture/source-tree.md]
- Formula calculation features: `/src/features/tpn-calculations/`
- Shared utilities: `/src/shared/lib/`
- Tests co-located with source files
- Follow FSD layer dependencies: features → entities → shared

#### Coding Standards [Source: architecture/coding-standards.md]
- Maximum 500 lines per component/module
- No `any` types - strict TypeScript
- All async operations wrapped in try-catch
- Code execution in sandboxed environment
- Use absolute imports with @ alias

#### Data Models [Source: architecture/data-models.md]
```typescript
// TPNValues type for calculations
export interface TPNValues {
  [key: string]: any;
}

// MockMeInterface for calculation context
export interface MockMeInterface {
  getValue: (key: string) => any;
  maxP: (value: number, precision?: number) => string;
  calculate?: (expression: string) => any;
}
```

### Formula Expression Examples
```typescript
// Basic arithmetic
"weight * 100"                    // Calories per kg
"(weight * 3.5) + baseProtein"    // Protein calculation

// Math functions
"min(weight * 4, maxProtein)"     // Capped protein
"round(bmi * stressFactor, 2)"    // Rounded BMI adjustment

// Unit conversions
"convert(weight, 'kg', 'lb')"     // Weight conversion
"height_cm / 100"                  // cm to meters

// Conditional logic (if supported)
"weight > 70 ? adultFormula : childFormula"
```

### Calculation Engine Pattern
```typescript
class FormulaEngine {
  private parser: ExpressionParser;
  private cache: LRUCache<string, any>;
  private validator: FormulaValidator;
  
  async calculate(
    formula: string,
    context: Record<string, any>
  ): Promise<CalculationResult> {
    // 1. Validate formula
    const validation = this.validator.validate(formula);
    if (!validation.isValid) {
      return { error: validation.error };
    }
    
    // 2. Check cache
    const cacheKey = this.getCacheKey(formula, context);
    if (this.cache.has(cacheKey)) {
      return { value: this.cache.get(cacheKey), cached: true };
    }
    
    // 3. Resolve variables
    const resolved = this.resolveVariables(formula, context);
    
    // 4. Parse and evaluate
    try {
      const result = this.parser.evaluate(resolved);
      this.cache.set(cacheKey, result);
      return { value: result, cached: false };
    } catch (error) {
      return { error: error.message };
    }
  }
}
```

### Dependency Resolution Pattern
```typescript
interface FormulaDependency {
  formula: string;
  dependencies: string[];
  result?: any;
}

class DependencyResolver {
  resolve(formulas: Map<string, string>): FormulaDependency[] {
    // Build dependency graph
    const graph = this.buildDependencyGraph(formulas);
    
    // Topological sort
    const sorted = this.topologicalSort(graph);
    
    // Return execution order
    return sorted;
  }
  
  private detectCycles(graph: DependencyGraph): string[] {
    // DFS to detect circular dependencies
    // Return list of variables in cycle
  }
}
```

### Library Recommendations
**Expression Parser Options:**
1. **mathjs** - Full-featured math library with expression parser
   - Pros: Comprehensive, well-tested, extensive functions
   - Cons: Large bundle size (500KB+)
   
2. **expr-eval** - Lightweight expression evaluator
   - Pros: Small (25KB), fast, sufficient for most needs
   - Cons: Limited math functions
   
3. **Function constructor** - Native JavaScript
   - Pros: No dependencies, full control
   - Cons: Security concerns, needs careful sandboxing

Recommendation: Use **expr-eval** for balance of size and features

### Security Considerations
- Never use eval() directly
- Sandbox all expression evaluation
- Whitelist allowed functions and operators
- Validate all user-provided formulas
- Limit execution time to prevent infinite loops
- Sanitize error messages before display

### Performance Targets
- Single formula calculation: < 10ms
- Batch of 100 formulas: < 500ms
- Cache hit ratio: > 80% in typical usage
- Memory usage: < 10MB for cache

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- Unit tests: 60% of test coverage
- Integration tests: 20% of test coverage
- Minimum 80% coverage for business logic
- Test files co-located with source
- Use Vitest for all testing

#### Test Cases to Cover
- Complex nested expressions
- All supported math functions
- Unit conversion accuracy
- Variable resolution edge cases
- Circular dependency detection
- Cache behavior under load
- Error handling and recovery
- Performance benchmarks

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial story creation | Scrum Master |
| 2025-09-06 | 1.1 | Implemented formula calculation engine | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_