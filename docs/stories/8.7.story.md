# Story 8.7: Settings & Preferences Page

## Status
Ready for Development

## Story
**As a** user,
**I want** to customize my application experience,
**so that** it works the way I prefer

## Acceptance Criteria
1. Theme preferences (dark/light/auto)
2. Default population type
3. Calculation precision settings
4. Export format preferences
5. Notification settings
6. Data management (clear cache, export data)

## Tasks / Subtasks
- [ ] **Task 1: Create SettingsPage with tabs** (AC: 1-6)
  - [ ] Create page at `src/app/settings/page.tsx`
  - [ ] Implement Material UI Tabs component
  - [ ] Create tab panels: Appearance, Defaults, Export, Data
  - [ ] Add responsive layout for mobile
  - [ ] Store active tab in URL params
  - [ ] Write tests for tab navigation

- [ ] **Task 2: Build PreferencesForm** (AC: 1-5)
  - [ ] Create form at `src/features/settings/ui/PreferencesForm.tsx`
  - [ ] Use React Hook Form for validation
  - [ ] Implement auto-save on change
  - [ ] Add reset to defaults button
  - [ ] Create success/error notifications
  - [ ] Test form validation

- [ ] **Task 3: Implement Appearance settings** (AC: 1)
  - [ ] Create ThemeSettings component
  - [ ] Add theme selector (light/dark/auto)
  - [ ] Implement color accent picker
  - [ ] Add font size adjustment
  - [ ] Create preview of theme changes
  - [ ] Test theme application

- [ ] **Task 4: Create Default Values settings** (AC: 2, 3)
  - [ ] Build DefaultsPanel component
  - [ ] Add population type selector
  - [ ] Create precision input (decimal places)
  - [ ] Add default units configuration
  - [ ] Implement calculation method preferences
  - [ ] Test default value application

- [ ] **Task 5: Build Export Preferences** (AC: 4)
  - [ ] Create ExportSettings component
  - [ ] Add default format selector
  - [ ] Configure PDF settings (margins, headers)
  - [ ] Set CSV delimiter preferences
  - [ ] Add filename template configuration
  - [ ] Test export settings

- [ ] **Task 6: Implement Data Management** (AC: 6)
  - [ ] Create DataManagement component
  - [ ] Add clear cache button with confirmation
  - [ ] Implement export all data function
  - [ ] Create import settings feature
  - [ ] Add storage usage display
  - [ ] Include data deletion options
  - [ ] Test data operations

- [ ] **Task 7: Implement settings persistence** (AC: All)
  - [ ] Create settings slice in Redux
  - [ ] Use localStorage for persistence
  - [ ] Implement settings migration for updates
  - [ ] Add settings sync across tabs
  - [ ] Create settings export/import
  - [ ] Test persistence across sessions

- [ ] **Task 8: Add keyboard shortcuts configuration** (AC: 5)
  - [ ] Create ShortcutsPanel component
  - [ ] Display current shortcuts
  - [ ] Allow custom shortcut assignment
  - [ ] Detect conflicts in shortcuts
  - [ ] Add reset shortcuts button
  - [ ] Test shortcut functionality

## Dev Notes

### Previous Story Context
- Stories 8.1-8.6: Core application pages complete
- No authentication required - settings stored locally
- Parent app shows preferences modal pattern

### Architecture References

#### Tech Stack [Source: architecture/tech-stack.md]
- **TypeScript**: 5.7+ with strict mode
- **Frontend Framework**: Next.js 15.5.2
- **UI Library**: Material UI 7.3.2
- **Forms**: React Hook Form
- **Storage**: localStorage

#### Project Structure [Source: architecture/source-tree.md]
Settings page location:
```
src/
├── app/
│   └── settings/
│       └── page.tsx       # Settings page
├── features/settings/
│   ├── ui/
│   │   ├── PreferencesForm.tsx
│   │   ├── ThemeSettings.tsx
│   │   ├── DefaultsPanel.tsx
│   │   ├── ExportSettings.tsx
│   │   ├── DataManagement.tsx
│   │   └── ShortcutsPanel.tsx
│   └── model/
│       └── settingsSlice.ts
└── shared/ui/
    └── atoms/
        └── Tabs/          # Tab component (new)
```

#### Data Models
```typescript
interface UserSettings {
  appearance: {
    theme: 'light' | 'dark' | 'auto';
    accentColor?: string;
    fontSize: 'small' | 'medium' | 'large';
  };
  defaults: {
    populationType: PopulationType;
    precision: number;
    units: 'metric' | 'imperial';
    calculationMethod: string;
  };
  export: {
    defaultFormat: 'pdf' | 'csv' | 'json' | 'html';
    pdfSettings: {
      pageSize: 'A4' | 'Letter';
      margins: number;
      includeHeader: boolean;
    };
    csvDelimiter: ',' | ';' | '\t';
    filenameTemplate: string;
  };
  shortcuts: Record<string, string>;
  notifications: {
    showSaveConfirmation: boolean;
    showExportSuccess: boolean;
    autoSaveEnabled: boolean;
    autoSaveInterval: number;
  };
}
```

### Component Dependencies
**New Components Needed:**
- Tabs - Material UI tab navigation
- PreferencesForm - Main settings form
- ThemeSettings - Appearance configuration
- DefaultsPanel - Default values
- ExportSettings - Export preferences
- DataManagement - Data operations
- ShortcutsPanel - Keyboard shortcuts

### Settings Categories
1. **Appearance**
   - Theme mode
   - Accent colors
   - Font sizes
   - UI density

2. **Defaults**
   - Population types
   - Calculation precision
   - Units of measurement
   - Formula defaults

3. **Export**
   - File formats
   - PDF configuration
   - CSV settings
   - Naming conventions

4. **Data**
   - Cache management
   - Data export/import
   - Storage cleanup
   - Reset options

### Local Storage Schema
```typescript
// localStorage keys
const SETTINGS_KEY = 'tpn-user-settings';
const THEME_KEY = 'tpn-theme';
const SHORTCUTS_KEY = 'tpn-shortcuts';

// Migration strategy
const migrateSettings = (oldSettings: any): UserSettings => {
  // Handle version upgrades
  // Apply defaults for new fields
  // Return migrated settings
};
```

### Testing Requirements

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Test Location**: `__tests__` folders
- **Framework**: Vitest 3.2.4

Key Test Scenarios:
1. Settings persist across sessions
2. Theme changes apply immediately
3. Defaults affect new documents
4. Export settings used correctly
5. Data operations complete successfully
6. Shortcuts don't conflict
7. Reset restores defaults
8. Migration handles old settings

### Performance Considerations
- Debounce settings saves (500ms)
- Lazy load tab content
- Cache theme calculations
- Optimize localStorage access

### Accessibility Requirements
- Keyboard navigation through tabs
- Form field descriptions
- Clear labeling of all options
- Confirmation dialogs for destructive actions
- Screen reader support

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
_To be populated by development agent_

### Agent Model Used
_To be populated_

### Debug Log References
_To be populated_

### Completion Notes List
_To be populated_

### File List
_To be populated_

## QA Results
_To be populated by QA agent_