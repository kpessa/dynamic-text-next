# Story 4.1: TPN Advisor Functions Migration

## Status
Ready for Review

## Story
**As a** medical professional,
**I want** TPN advisor functions migrated from the Svelte application,
**so that** I can calculate Total Parenteral Nutrition values for different patient populations.

## Acceptance Criteria
1. TPN advisor types implemented (NEO, CHILD, ADOLESCENT, ADULT)
2. Core calculation functions migrated from Svelte
3. Ingredient reference ranges by advisor type
4. Validation of calculated values against safe ranges
5. Unit conversions and precision handling
6. Redux state management for TPN instances
7. Calculation results displayed in UI

## Tasks / Subtasks
- [x] **Task 1: Create TPN Types and Models** (AC: 1)
  - [x] Define TypeScript interfaces at `src/entities/tpn/types/index.ts`
  - [x] Create TPNAdvisorType enum (NEO, CHILD, ADOLESCENT, ADULT)
  - [x] Define TPNInstance interface with values and advisor type
  - [x] Create TPNValues type for calculation results
  - [x] Define MockMeInterface for calculation context

- [x] **Task 2: Migrate Core Calculation Logic** (AC: 2, 5)
  - [x] Create calculation service at `src/features/tpn-calculations/lib/calculator.ts`
  - [x] Port getValue function for retrieving values by key
  - [x] Port maxP function for precision formatting
  - [x] Port calculate function for expression evaluation
  - [x] Implement unit conversion utilities
  - [x] Create calculation context with MockMe pattern

- [x] **Task 3: Implement Advisor-Specific Logic** (AC: 1, 3)
  - [x] Create advisor configurations at `src/features/tpn-calculations/config/advisors.ts`
  - [x] Define NEO (neonatal/infant) calculation rules
  - [x] Define CHILD calculation rules
  - [x] Define ADOLESCENT calculation rules
  - [x] Define ADULT calculation rules
  - [x] Set up reference ranges per advisor type

- [x] **Task 4: Create Ingredient Management** (AC: 3, 4)
  - [x] Define ingredient types at `src/entities/ingredient/types/index.ts`
  - [x] Create ingredient service at `src/entities/ingredient/model/ingredientService.ts`
  - [x] Implement reference range validation
  - [x] Create ingredient lookup by keyname
  - [x] Handle shared vs custom ingredients

- [x] **Task 5: Build Redux Integration** (AC: 6)
  - [x] Create TPN slice at `src/features/tpn-calculations/model/tpnSlice.ts`
  - [x] Store active TPN instances
  - [x] Track calculation history
  - [x] Manage advisor type selection
  - [x] Handle calculation errors
  - [x] Create selectors for TPN data

- [x] **Task 6: Create Calculation UI Components** (AC: 7)
  - [x] Create TPNCalculator component at `src/features/tpn-calculations/ui/TPNCalculator.tsx`
  - [x] Build advisor type selector
  - [x] Create input fields for patient parameters
  - [x] Display calculation results
  - [x] Show validation warnings for out-of-range values
  - [x] Add export functionality for results

- [x] **Task 7: Implement Validation and Safety Checks** (AC: 4)
  - [x] Create validation service at `src/features/tpn-calculations/lib/validator.ts`
  - [x] Check calculated values against reference ranges
  - [x] Implement safety alerts for critical values
  - [x] Validate input parameters
  - [x] Create warning system for edge cases

- [x] **Task 8: Write Tests** (AC: All)
  - [x] Unit tests for calculation functions
  - [x] Test each advisor type calculations
  - [x] Test reference range validations
  - [x] Test unit conversions
  - [x] Test Redux state updates
  - [x] Integration tests for complete calculations

## Dev Notes

### Previous Story Context
From Epic 3:
- Firebase/Firestore setup complete for data persistence
- Redux configured for state management
- JSON import available for loading configurations

### TPN Calculation Pattern
From Svelte migration:
```typescript
// Core calculation context
class MockMe implements MockMeInterface {
  private values: Record<string, any>;
  private advisorType: TPNAdvisorType;
  
  constructor(values: Record<string, any>, advisorType: TPNAdvisorType) {
    this.values = values;
    this.advisorType = advisorType;
  }
  
  getValue(key: string): any {
    return this.values[key] ?? 0;
  }
  
  maxP(value: number, precision: number = 2): string {
    return value.toFixed(precision);
  }
  
  calculate(expression: string): any {
    // Safe expression evaluation
    // Consider using math expression parser library
    return evaluateExpression(expression, this.values);
  }
}
```

### Advisor Type Configurations
```typescript
const advisorConfigs = {
  NEO: {
    aliases: ['neonatal', 'infant'],
    weightRange: { min: 0.5, max: 10 }, // kg
    calculations: {
      calories: 'weight * 100', // kcal/kg/day
      protein: 'weight * 3.5',   // g/kg/day
      // ... more calculations
    }
  },
  CHILD: {
    aliases: ['child'],
    weightRange: { min: 10, max: 30 },
    calculations: {
      calories: 'weight * 75',
      protein: 'weight * 2.5',
      // ... more calculations
    }
  },
  // ... ADOLESCENT, ADULT
};
```

### Ingredient Reference Ranges
```typescript
interface ReferenceRange {
  threshold: string;
  value: number;
  advisorType: TPNAdvisorType;
  unit: string;
}

const sodiumRanges: ReferenceRange[] = [
  { threshold: 'min', value: 2, advisorType: 'NEO', unit: 'mEq/kg' },
  { threshold: 'max', value: 4, advisorType: 'NEO', unit: 'mEq/kg' },
  { threshold: 'min', value: 2, advisorType: 'ADULT', unit: 'mEq/kg' },
  { threshold: 'max', value: 3, advisorType: 'ADULT', unit: 'mEq/kg' },
];
```

### Expression Evaluation Safety
For safe mathematical expression evaluation, consider:
1. Using a library like `mathjs` or `expr-eval`
2. Sanitizing expressions to prevent code injection
3. Whitelisting allowed operations and functions

```typescript
import { evaluate } from 'mathjs';

function evaluateExpression(expr: string, context: Record<string, any>): number {
  try {
    // Create safe evaluation scope
    const scope = { ...context };
    return evaluate(expr, scope);
  } catch (error) {
    console.error('Expression evaluation failed:', expr, error);
    return 0;
  }
}
```

### Redux State Structure
```typescript
interface TPNState {
  instances: TPNInstance[];
  activeInstanceId: string | null;
  advisorType: TPNAdvisorType;
  calculations: {
    loading: boolean;
    results: TPNValues | null;
    errors: string[];
    warnings: string[];
  };
  history: CalculationHistory[];
}
```

### Validation Warnings
```typescript
interface ValidationResult {
  isValid: boolean;
  warnings: ValidationWarning[];
  errors: ValidationError[];
}

interface ValidationWarning {
  field: string;
  value: number;
  range: { min: number; max: number };
  message: string;
  severity: 'low' | 'medium' | 'high';
}
```

### Testing Requirements

#### Testing Standards
From [Source: architecture/testing-strategy.md]:
- Unit test all calculation functions with known inputs/outputs
- Test each advisor type with typical patient scenarios
- Validate reference range checking
- Test error handling for invalid inputs
- Integration tests for complete TPN calculations

#### Test Cases per Advisor
- NEO: Premature infant, term newborn
- CHILD: Toddler, school-age child
- ADOLESCENT: Early teen, late teen
- ADULT: Standard adult, elderly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (claude-3-5-sonnet-20241022)

### Debug Log References
No critical errors encountered during implementation.

### Completion Notes List
- Successfully migrated TPN advisor functions from Svelte to Next.js
- Implemented all four advisor types (NEO, CHILD, ADOLESCENT, ADULT)
- Created comprehensive calculation engine with safe expression evaluation using mathjs
- Built complete Redux integration with async thunks for calculations
- Implemented robust validation system with multi-level severity warnings
- All tests passing with good coverage
- Component created with Material UI integration

### File List
**Created:**
- src/entities/tpn/types/index.ts
- src/entities/tpn/types/index.test.ts
- src/entities/tpn/index.ts
- src/features/tpn-calculations/lib/calculator.ts
- src/features/tpn-calculations/lib/calculator.test.ts
- src/features/tpn-calculations/config/advisors.ts
- src/features/tpn-calculations/config/advisors.test.ts
- src/entities/ingredient/model/tpnIngredientService.ts
- src/entities/ingredient/model/tpnIngredientService.test.ts
- src/features/tpn-calculations/model/tpnSlice.test.ts
- src/features/tpn-calculations/ui/TPNCalculator.tsx
- src/features/tpn-calculations/ui/TPNCalculator.test.tsx
- src/features/tpn-calculations/index.ts
- src/features/tpn-calculations/lib/validator.ts
- src/features/tpn-calculations/lib/validator.test.ts

**Modified:**
- src/features/tpn-calculations/model/tpnSlice.ts (replaced with comprehensive version)
- package.json (added mathjs dependency)

## QA Results
_To be populated by QA agent_